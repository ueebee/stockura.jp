# 外部 API レートリミット機能の要件

## 概要
外部 API（J-Quants 、 yfinance）に対するリクエスト頻度を制御するレートリミット機能を実装する。

## 目的
- 外部 API のレート制限に違反しないようにリクエスト頻度を制御する
- アプリケーションの安定性を向上させる
- API プロバイダーからのアクセス制限や BAN を防ぐ

## 要件

### 1. レートリミット設定
- **API 単位でのレート制限設定**
  - J-Quants API 全体に対するレート制限
  - yfinance API 全体に対するレート制限
  - 各 API に対して独立した制限を設定可能

- **設定項目**
  - リクエスト数の上限（例：100 リクエスト）
  - 時間窓（例：1 分、 1 時間、 1 日）
  - バースト許容量（短時間での最大リクエスト数）

### 2. レートリミット実装方式
- **トークンバケットアルゴリズム**を採用
  - 一定期間ごとにトークンが補充される
  - リクエスト時にトークンを消費
  - トークンがない場合は待機またはエラー

### 3. 設定管理
- **環境変数での設定**
  - `JQUANTS_RATE_LIMIT_REQUESTS`: J-Quants のリクエスト数上限
  - `JQUANTS_RATE_LIMIT_WINDOW`: J-Quants の時間窓（秒）
  - `YFINANCE_RATE_LIMIT_REQUESTS`: yfinance のリクエスト数上限
  - `YFINANCE_RATE_LIMIT_WINDOW`: yfinance の時間窓（秒）

- **デフォルト値**
  - J-Quants: 100 リクエスト/分
  - yfinance: 2000 リクエスト/時間

### 4. エラーハンドリング
- **レート制限到達時の挙動**
  - デフォルト：次のトークンが利用可能になるまで待機
  - オプション：即座に RateLimitError を発生

- **リトライ機能**
  - レート制限エラー時の自動リトライ
  - 指数バックオフによる待機時間の調整

### 5. モニタリング
- **ログ出力**
  - レート制限の状態（残りトークン数）
  - レート制限到達時の警告
  - 待機時間の記録

### 6. 実装の非侵襲性
- 既存のクライアントコードへの影響を最小限に抑える
- デコレーターパターンまたはミドルウェアパターンで実装
- 既存の base_client クラスの拡張として実装

### 7. 将来の拡張性
- エンドポイント単位でのレート制限設定への拡張が容易
- 異なるレートリミットアルゴリズムへの切り替えが可能
- 分散環境での共有レート制限（Redis 等）への対応

## 制約事項
- 初回実装では、 API 単位でのレート制限のみ対応
- エンドポイント単位の細かい制限は将来の拡張として扱う
- 分散環境での共有レート制限は初回実装に含まない

## 実装フェーズ分け

### フェーズ 1（初回実装）
- **共通レートリミッター基盤の実装**
  - トークンバケットアルゴリズムの実装
  - API 横断で使える汎用的なレートリミッタークラス
  - 環境変数からの設定読み込み
  - 基本的な待機機能（トークンが利用可能になるまで待機）
  - ログ出力（残りトークン数、待機時間）

- **各 API クライアントへの統合**
  - J-Quants base_client への統合
  - yfinance base_client への統合
  - デコレーターパターンでの実装

- **基本的なテスト**
  - 単体テスト
  - 統合テスト

### フェーズ 2（将来の拡張）
- 指数バックオフの実装
- リトライ機能の強化
- エンドポイント単位でのレート制限
- 分散環境での共有レート制限（Redis 使用）
- より高度なモニタリング機能

## 成功基準（フェーズ 1）
1. 共通のレートリミッタークラスが実装されている
2. J-Quants と yfinance の両方で同じレートリミッターを使用している
3. レート制限到達時に適切に待機する
4. 既存の API クライアントコードに大きな変更を加えずに導入できる
5. レート制限の状態がログで確認できる
6. 単体テストでレートリミット機能が検証されている