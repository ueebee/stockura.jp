# Presentation 層クリーンアーキテクチャ改善 第 4 回 要件書

## 1. 背景

これまでの改善（第 1 回〜第 3 回）により、以下が実現されています：
- 第 1 回: Presentation 層の依存性注入の改善
- 第 2 回: CLI 層の依存性注入の改善  
- 第 3 回: Mapper パターンの導入による DTO 変換の整理

今回は第 4 回として、更なるクリーンアーキテクチャの観点から Presentation 層を改善します。

## 2. 現状の課題

### 2.1 エラーハンドリングの不統一
- API エンドポイントと CLI コマンドでエラーハンドリングの方法が異なる
- HTTP エラーレスポンスのフォーマットが統一されていない
- ビジネスロジックエラーとシステムエラーの区別が不明確

### 2.2 ミドルウェアの未活用
- `middleware`ディレクトリが存在するが空のまま
- クロスカッティングな関心事（認証、ロギング、エラーハンドリング等）が各エンドポイントに散在

### 2.3 入力検証の分散
- 一部の検証が Presentation 層で行われ、一部が Domain 層で行われている
- 検証エラーメッセージの一貫性がない

### 2.4 レスポンス構造の不統一
- 成功時とエラー時のレスポンス構造が異なる
- ページネーション等の共通メタデータの扱いが統一されていない

## 3. 改善要件

### 3.1 統一的なエラーハンドリング機構の導入
- **要件 ID**: REQ-001
- **内容**: 
  - Presentation 層全体で使用する統一的なエラーハンドリング機構を実装する
  - ビジネスエラーとシステムエラーを適切に区別して処理する
  - HTTP ステータスコードとエラーメッセージのマッピングを定義する

### 3.2 ミドルウェアレイヤーの実装
- **要件 ID**: REQ-002
- **内容**:
  - エラーハンドリングミドルウェアを実装する
  - リクエスト/レスポンスロギングミドルウェアを実装する
  - 必要に応じて認証ミドルウェアを実装する

### 3.3 入力検証の整理
- **要件 ID**: REQ-003
- **内容**:
  - Presentation 層での入力検証を整理し、責務を明確化する
  - 検証エラーメッセージのフォーマットを統一する
  - Pydantic を活用した宣言的な検証を推進する

### 3.4 統一的なレスポンス構造の定義
- **要件 ID**: REQ-004
- **内容**:
  - 成功時とエラー時の統一的なレスポンス構造を定義する
  - ページネーション、メタデータを含む共通レスポンスラッパーを実装する
  - API バージョニングに対応した構造を検討する

### 3.5 CLI コマンドのエラーハンドリング改善
- **要件 ID**: REQ-005
- **内容**:
  - CLI コマンドにも統一的なエラーハンドリングを適用する
  - ユーザーフレンドリーなエラーメッセージを提供する
  - 終了コードを適切に設定する

## 4. 制約事項

- 既存の API インターフェースとの後方互換性を保つ
- 細かく動く状態を維持しながら段階的に改善する
- 各改善ステップごとにテストが通ることを確認する
- 過度に複雑な実装は避け、シンプルさを重視する

## 5. 成功基準

- すべての API エンドポイントで統一的なエラーハンドリングが実装されている
- ミドルウェアレイヤーが適切に機能している
- 入力検証が整理され、一貫性のあるエラーメッセージが返される
- レスポンス構造が統一され、クライアント側での処理が簡潔になる
- CLI コマンドでも適切なエラーハンドリングが実装されている
- 既存のテストがすべて通り、新規機能に対するテストが追加されている