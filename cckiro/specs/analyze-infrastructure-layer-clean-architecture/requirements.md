# Infrastructure 層クリーンアーキテクチャ改善要件

## 1. 概要

本ドキュメントは、 Stockura プロジェクトの infrastructure 層をクリーンアーキテクチャの観点から分析し、改善すべき点を特定して実装するための要件を定義します。

## 2. 現状分析

### 2.1 現在の infrastructure 層の構成
- **cache/**: キャッシュ関連（現在は空）
- **celery/**: タスクキュー（Celery）関連
- **database/**: データベース接続と ORM モデル
- **di/**: 依存性注入プロバイダー
- **events/**: イベントパブリッシャー
- **external_api/**: 外部 API 用ディレクトリ（内容が空）
- **job_queue/**: ジョブキュー（内容が空）
- **jquants/**: J-Quants API クライアント
- **redis/**: Redis クライアント
- **repositories/**: リポジトリ実装

### 2.2 クリーンアーキテクチャの観点での問題点

#### 2.2.1 依存関係の問題
- infrastructure 層が domain 層のエンティティや例外を直接参照している
- 外部ライブラリ（SQLAlchemy 、 aiohttp 等）への依存が上位層に漏れ出す可能性がある

#### 2.2.2 責務の分離が不完全
- external_api ディレクトリと jquants ディレクトリが重複している
- cache と redis の役割が明確でない
- job_queue と celery の責務が重複している

#### 2.2.3 インターフェースの抽象化不足
- 外部サービスクライアントのインターフェースが domain 層に定義されていない
- データベース接続の抽象化が不十分

#### 2.2.4 設定管理
- infrastructure 固有の設定が core 層に依存している

## 3. 改善要件

### 3.1 依存関係の整理
- [ ] infrastructure 層から domain 層への依存を最小化
- [ ] 外部ライブラリへの依存を infrastructure 層に閉じ込める
- [ ] 適切な DTO やマッパーを使用した層間のデータ変換

### 3.2 ディレクトリ構造の再編成
- [ ] 重複したディレクトリの統合（external_api + jquants → external_services）
- [ ] 未使用ディレクトリの削除または実装
- [ ] 責務に基づいた明確なディレクトリ構造

### 3.3 インターフェースの定義
- [ ] 外部サービスクライアントのインターフェースを domain 層に移動
- [ ] データベース接続の抽象化インターフェース作成
- [ ] キャッシュの抽象化インターフェース作成

### 3.4 設定管理の改善
- [ ] infrastructure 固有の設定を infrastructure 層内で管理
- [ ] 環境変数の読み込みと検証を infrastructure 層で実施

### 3.5 エラーハンドリングの統一
- [ ] infrastructure 層固有の例外階層の定義
- [ ] domain 層の例外への適切な変換

### 3.6 テスタビリティの向上
- [ ] モックやスタブを作成しやすい構造への改善
- [ ] インターフェースベースの設計強化

## 4. 優先順位

1. **高優先度**
   - 依存関係の整理
   - インターフェースの定義と移動
   - ディレクトリ構造の再編成

2. **中優先度**
   - 設定管理の改善
   - エラーハンドリングの統一

3. **低優先度**
   - テスタビリティの向上
   - 未使用ディレクトリの実装

## 5. 成功基準

- infrastructure 層が domain 層に依存しない
- 外部ライブラリへの依存が infrastructure 層に閉じ込められている
- 各コンポーネントが単一責任の原則に従っている
- テストが書きやすく、保守しやすい構造になっている