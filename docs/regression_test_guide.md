# リグレッションテストガイド

## 概要

リグレッションテストスクリプト（`bin/regression_test.py`）は、リファクタリング後の動作確認を行うためのツールです。
データベースをクリーンな状態にリセットし、主要機能の動作確認を手動または自動で行えます。

## 使用方法

### 手動テストモード（デフォルト）

```bash
python bin/regression_test.py
```

実行すると、以下の処理が行われます：

1. データベースのリセット（確認プロンプトあり）
2. 手動テスト手順の表示

### 自動テストモード

```bash
# Playwrightのインストールが必要
pip install playwright
playwright install chromium

# 自動テストの実行
python bin/regression_test.py --auto
```

自動テストモードでは：

1. データベースのリセット
2. ブラウザを自動操作して主要機能をテスト
3. テスト結果レポートとスクリーンショットを生成

### オプション

- `--auto`: 自動ブラウザテストモードで実行
- `--no-confirm`: データベースリセットの確認プロンプトをスキップ

## データベースリセット処理

以下のコマンドが順次実行されます：

```bash
docker compose down
docker volume rm stockurajp_postgres_data
docker compose up -d
docker compose exec -T web alembic upgrade head
docker compose down
docker compose up -d
```

## 手動テスト項目

### 1. 上場企業一覧のテスト

#### 1-1. 手動同期テスト
- データソース管理画面にアクセス
- J-Quantsデータソースを選択
- APIエンドポイント管理画面へ移動
- 上場企業一覧の「詳細」をクリック
- 「今すぐ同期」ボタンをクリック
- 実行履歴に「完了」ステータスが表示されることを確認

#### 1-2. 定期実行スケジュールテスト
- 実行時刻に2分後の時刻を入力（スクリプトが自動計算して表示）
- 「スケジュール保存」ボタンをクリック
- 約2分待機
- 「履歴を更新」ボタンをクリック
- 実行履歴に実行タイプ「Scheduled」、ステータス「完了」が表示されることを確認

### 2. 日次株価データのテスト

#### 2-1. 手動同期テスト
- 日次株価データの「詳細」をクリック
- 「過去7日間」ボタンをクリック
- 「同期を開始」ボタンをクリック
- 実行履歴に同期タイプ「Full」、実行タイプ「Manual」、ステータス「完了」が表示されることを確認

#### 2-2. 定期実行スケジュールテスト
- スケジュール名に「テストスケジュール」を入力
- 実行時刻に2分後の時刻を入力
- 実行頻度で「毎日」を選択
- 取得期間で「実行日から過去7日間」を選択
- 「保存」ボタンをクリック
- 約2分待機
- 「履歴を更新」ボタンをクリック
- 実行履歴に同期タイプ「Full」、実行タイプ「Scheduled」、ステータス「完了」が表示されることを確認

## 自動テストで確認される項目

### 1. 上場企業一覧
- 手動同期の実行と完了確認
- 実行履歴への記録確認

### 2. 日次株価データ
- 過去7日間のデータ同期実行
- 同期完了と実行履歴の確認

## 実行例

### 手動テストモード

2025年7月23日に実行した例：

#### 上場企業一覧の手動同期
- 実行時刻: 2025-07-23 10:31:35
- 同期タイプ: full
- 実行タイプ: manual
- ステータス: 完了
- 更新件数: 4,416社
- 処理時間: 3.2秒

#### 日次株価データの手動同期
- 実行時刻: 2025-07-23 10:32:35
- 同期タイプ: full
- 実行タイプ: manual
- 期間: 2025-07-16 〜 2025-07-22
- ステータス: 完了
- 更新件数: 17,650件
- スキップ: 2件
- 処理時間: 31.7秒

### 自動テストモード

```bash
$ python bin/regression_test.py --auto

[2025-07-23 10:45:00] [INFO] リグレッションテストを開始します
[2025-07-23 10:45:00] [INFO] データベースのリセットを開始します
...
[2025-07-23 10:45:30] [INFO] 自動ブラウザテストモードで実行します
[2025-07-23 10:45:35] [INFO] 上場企業一覧の同期テストを開始します
[2025-07-23 10:46:10] [SUCCESS] 手動同期テストが成功しました
[2025-07-23 10:46:15] [INFO] 日次株価データの同期テストを開始します
[2025-07-23 10:47:00] [SUCCESS] 手動同期テストが成功しました

============================================================
自動テスト結果サマリー
============================================================
実行日時: 2025-07-23 10:45:00
実行時間: 0:02:00
総テスト数: 2
成功: 2
失敗: 0
============================================================
✅ 上場企業一覧同期
✅ 日次株価データ同期
============================================================
詳細なレポートは regression_test_report_20250723_104500.json に保存されました
スクリーンショット: test_company_manual_sync_success.png, test_daily_quotes_manual_sync_success.png
```

## 注意事項

1. **データベースのリセット**: 実行すると全てのデータが削除されます。本番環境では絶対に実行しないでください。

2. **定期実行テスト**: スケジュールテストは実際に指定時刻まで待つ必要があります。テスト時間を短縮するため、2分後の設定を推奨しています。

3. **外部API依存**: J-Quants APIを実際に呼び出すため、ネットワーク接続とAPIトークンが必要です。

4. **Docker環境**: Docker ComposeとDockerが正しくインストールされ、起動している必要があります。

## トラブルシューティング

### PostgreSQLボリューム削除エラー
```
Error response from daemon: remove stockurajp_postgres_data: volume is in use
```
このエラーが出る場合は、コンテナが完全に停止していない可能性があります。少し待ってから再実行してください。

### マイグレーションエラー
データベースの初期化に失敗する場合は、以下を確認してください：
- PostgreSQLコンテナが正常に起動しているか
- alembicのマイグレーションファイルが正しく配置されているか

### API認証エラー
J-Quants APIの認証に失敗する場合は、環境変数や設定ファイルのAPIキーを確認してください。