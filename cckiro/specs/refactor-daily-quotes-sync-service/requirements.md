# DailyQuotesSyncService リファクタリング要件

## 概要
現在のDailyQuotesSyncServiceは761行の巨大なクラスとなっており、責務が混在している。
CompanySyncServiceで実施したリファクタリングと同様のアプローチで、責務を分離し、テスタビリティと保守性を向上させる。

## 現状の課題

### 1. 責務の混在
- データ取得（J-Quants APIアクセス）
- データ検証・変換
- データベース操作
- エラーハンドリング
- 履歴管理

これらが1つのクラスに混在しており、単一責任の原則に違反している。

### 2. テスタビリティの低さ
- データベースセッションの扱いが一貫していない（初期化時とasync_session_maker混在）
- 外部依存（J-Quants API）が直接参照されており、モックが困難
- 巨大なメソッドにより、単体テストが書きにくい

### 3. 再利用性の欠如
- CompanySyncServiceで導入されたインターフェース分離パターンが適用されていない
- 他のサービスから機能を再利用することが困難

### 4. エラーハンドリングの重複
- 同様のエラー処理ロジックが複数箇所に散在
- エラーの種類に応じた適切な処理が整理されていない

## 機能要件

### 1. 既存機能の維持
- 全データ同期（full sync）
- 増分同期（incremental sync）
- 特定銘柄同期（single stock sync）
- 同期履歴の管理
- エラーハンドリング

### 2. インターフェースベースの設計
CompanySyncServiceと同様に、以下のインターフェースを定義：
- `IDailyQuotesDataFetcher`: 株価データの取得
- `IDailyQuotesDataMapper`: データの検証・変換
- `IDailyQuotesRepository`: データベース操作

### 3. 依存性注入の実装
- 各コンポーネントは依存性注入により提供
- テスト時にモック実装を注入可能にする

### 4. エラーハンドリングの統一
- 既存のErrorHandlerクラスを活用
- エラー種別に応じた適切な処理を集約

## 非機能要件

### 1. パフォーマンス
- 既存の処理速度を維持または改善
- バッチ処理の効率性を保持
- メモリ使用量の最適化（既存の100件ごとのコミット処理を維持）

### 2. 互換性
- 既存のAPIインターフェースを維持
- データベーススキーマの変更なし
- 既存のタスクキューとの互換性維持

### 3. テスタビリティ
- 各コンポーネントを独立してテスト可能
- モック実装を容易に作成可能
- 統合テストも実施可能

### 4. 保守性
- コードの可読性向上
- 責務が明確に分離された構造
- ドキュメンテーションの充実

## 制約事項

1. **後方互換性の維持**
   - 既存のタスクから呼び出されるインターフェースは変更しない
   - パラメータ名、戻り値の型は維持

2. **段階的な移行**
   - 段階的な移行は不要です。

3. **既存のデータベース構造**
   - テーブル構造の変更なし
   - 既存のデータとの整合性維持

## 成功基準

1. **コード品質**
   - 各クラスが200行以下
   - 単一責任の原則に従った設計
   - 適切なインターフェース分離

2. **テストカバレッジ**
   - 各コンポーネントの単体テスト作成
   - 主要なシナリオの統合テスト作成
   - エラーケースのテスト網羅

3. **パフォーマンス**
   - 既存の処理時間から10%以上の劣化なし
   - メモリ使用量の増加なし

4. **保守性**
   - コードレビューでの承認
   - ドキュメントの完備
   - 将来の拡張が容易な設計
