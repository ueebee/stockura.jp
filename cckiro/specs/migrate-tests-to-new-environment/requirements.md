# 既存テストの新テスト環境への移行 要件仕様書

## 1. 概要
現在のブランチ（feature/test-environment-setup）で構築した新しいテスト環境に、既存のテストを全て移行する。

## 2. 背景と目的
- **背景**: 新しいテスト環境（pytest + factory_boy + 各種フィクスチャ）が整備された
- **目的**: 既存のテストを新環境の機能を活用できるように移行し、テストの品質と保守性を向上させる

## 3. 現状分析

### 3.1 新テスト環境の主要機能
- pytest ベースのテスト実行環境
- factory_boy を使用したテストデータ生成
- 共通フィクスチャ（database, clients, factories）
- テスト設定の一元管理（test_config.py）
- 環境変数の分離（.env.test）

### 3.2 既存テストの構成
```
tests/
├── unit/
│   ├── application/use_cases/
│   │   ├── test_auth_use_case.py
│   │   └── test_stock_use_case.py
│   ├── domain/entities/
│   │   ├── test_stock.py
│   │   └── test_stock_v2.py
│   └── infrastructure/
│       ├── jquants/
│       │   ├── test_auth_repository.py
│       │   ├── test_base_client.py
│       │   └── test_jquants_auth_repository.py
│       └── redis/
│           └── test_redis_auth_repository.py
├── integration/api/
│   └── test_auth_endpoints.py
└── sample_test.py
```

## 4. 移行要件

### 4.1 移行対象
- [ ] 全ての単体テスト（unit/）
- [ ] 全ての統合テスト（integration/）
- [ ] 既存のモック・フィクスチャ定義

### 4.2 移行後の品質基準
- [ ] 全てのテストが新環境で正常に動作すること
- [ ] テストの実行速度が同等以上であること
- [ ] コードカバレッジが維持されること
- [ ] テストの可読性が向上すること

### 4.3 活用すべき新機能
- [ ] factory_boy を使用したテストデータ生成への置き換え
- [ ] 共通フィクスチャの活用（重複コードの削除）
- [ ] conftest.py のグローバルフィクスチャの活用
- [ ] テスト設定の一元管理

## 5. 移行方針

### 5.1 段階的移行
1. **Phase 1**: 既存テストの動作確認（現状のまま新環境で実行）
2. **Phase 2**: 共通フィクスチャへの置き換え
3. **Phase 3**: factory_boy を使用したテストデータ生成への移行
4. **Phase 4**: 重複コードの削除とリファクタリング

### 5.2 移行の優先順位
1. 単体テスト（依存関係が少ない）
2. 統合テスト（API エンドポイント）
3. その他のテスト

### 5.3 移行時の注意事項
- 既存のテストロジックは変更しない（リファクタリングは別フェーズ）
- テストの意図を保持する
- 移行前後でテスト結果が同一であることを確認する

## 6. 具体的な移行内容

### 6.1 モック・フィクスチャの統合
- 各テストファイルで定義されているモックを共通フィクスチャに移行
- 重複するフィクスチャ定義の統合

### 6.2 テストデータ生成の改善
- ハードコードされたテストデータを factory_boy に置き換え
- AuthFactory, StockFactory の活用

### 6.3 非同期テストの最適化
- pytest-asyncio の機能を最大限活用
- 非同期フィクスチャの適切な使用

## 7. 成功基準
- [ ] 全てのテストが新環境で実行できる
- [ ] テストの実行時間が改善または維持される
- [ ] コードの重複が削減される
- [ ] 新しいテストの追加が容易になる

## 8. リスクと対策
- **リスク**: 移行中のテスト失敗による開発への影響
- **対策**: ブランチを分けて段階的に移行、各段階でのレビュー実施

## 9. 期待される成果
- テストコードの保守性向上
- 新規テスト作成の効率化
- テスト実行の高速化
- コードカバレッジの可視化