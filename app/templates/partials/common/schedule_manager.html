{# 共通スケジュール管理コンポーネント
使用方法:
set schedule_config = {
    'type': 'simple' or 'advanced',  (simple: 時間のみ, advanced: 完全機能)
    'endpoint_type': 'companies' or 'daily_quotes',
    'api_base_url': '/api/v1/companies/sync/schedule' or '/api/v1/daily-quotes/schedules',
    'allow_multiple': false or true,  (複数スケジュール許可)
    'show_name': false or true,      (名前フィールド表示)
    'show_relative_preset': false or true,  (相対期間設定表示)
    'default_time': '05:00',
    'container_id': 'schedule-modal',  (一意のコンテナID)
    'form_id': 'schedule-form'        (一意のフォームID)
}
include "partials/common/schedule_manager.html"
#}

{% set config = schedule_config %}
{% set is_simple = config.type == 'simple' %}
{% set container_id = config.container_id|default('schedule-modal') %}
{% set form_id = config.form_id|default('schedule-form') %}

<!-- スケジュールモーダル/フォームコンテナ -->
<div id="{{ container_id }}" 
     class="{% if is_simple %}hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50{% else %}bg-gray-50 border border-gray-200 rounded-lg p-6 mt-4{% endif %}"
     {% if not is_simple %}style="display: none;"{% endif %}>
    
    <div class="{% if is_simple %}bg-white rounded-lg shadow-xl max-w-md w-full mx-4{% else %}w-full{% endif %}">
        <!-- ヘッダー -->
        <div class="{% if is_simple %}px-6 py-4 border-b border-gray-200{% else %}flex items-center justify-between mb-4{% endif %}">
            <h3 class="text-lg font-semibold text-gray-900" id="{{ container_id }}-title">
                {% if is_simple %}定期実行時間の設定{% else %}新規定期実行スケジュール{% endif %}
            </h3>
            {% if not is_simple %}
            <button onclick="closeSchedule{{ config.endpoint_type|replace('_', '')|capitalize }}Form()" class="text-gray-400 hover:text-gray-500">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            {% endif %}
        </div>
        
        <!-- フォーム -->
        <form id="{{ form_id }}" onsubmit="submitSchedule{{ config.endpoint_type|replace('_', '')|capitalize }}Form(event)">
            <input type="hidden" id="{{ form_id }}-schedule-id" name="schedule_id" value="">
            
            <div class="{% if is_simple %}px-6 py-4{% else %}space-y-4{% endif %}">
                {% if config.show_name %}
                <!-- スケジュール名（日次株価のみ） -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">スケジュール名 <span class="text-red-500">*</span></label>
                        <input type="text" id="{{ form_id }}-name" name="name" required
                               placeholder="例: 日次更新（過去7日間）"
                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">説明（任意）</label>
                        <input type="text" id="{{ form_id }}-description" name="description"
                               placeholder="例: 毎朝6時に過去7日間のデータを取得"
                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                {% endif %}
                
                {% if config.show_relative_preset %}
                <!-- 取得期間（日次株価のみ） -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">取得期間 <span class="text-red-500">*</span></label>
                        <select id="{{ form_id }}-relative-preset" name="relative_preset" required
                                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="yesterday">前日のみ</option>
                            <option value="last7days" selected>実行日から過去7日間</option>
                            <option value="last30days">実行日から過去30日間</option>
                            <option value="last90days">実行日から過去90日間</option>
                            <option value="thisMonth">実行月の1日から前日まで</option>
                            <option value="lastMonth">前月全体</option>
                        </select>
                    </div>
                </div>
                {% endif %}
                
                <!-- 実行時刻設定 -->
                {% if is_simple %}
                <label class="block text-sm font-medium text-gray-700 mb-2">実行時間 (JST)</label>
                <div class="flex items-center space-x-2">
                    <select name="hour" id="{{ form_id }}-hour" class="block w-20 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        {% for h in range(24) %}
                        <option value="{{ h }}" {% if h == 5 %}selected{% endif %}>{{ '%02d'|format(h) }}</option>
                        {% endfor %}
                    </select>
                    <span class="text-lg font-medium text-gray-700">:</span>
                    <select name="minute" id="{{ form_id }}-minute" class="block w-20 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        {% for m in range(60) %}
                        <option value="{{ m }}">{{ '%02d'|format(m) }}</option>
                        {% endfor %}
                    </select>
                </div>
                <p class="mt-2 text-sm text-gray-500">
                    ※ 毎日指定時刻に自動実行されます<br>
                    ※ 処理時間を考慮して、取引時間外を推奨
                </p>
                {% else %}
                <!-- 詳細スケジュール設定（日次株価） -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">実行頻度</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button type="button" id="{{ form_id }}-type-daily"
                                    onclick="setSchedule{{ config.endpoint_type|replace('_', '')|capitalize }}Type('daily')"
                                    class="schedule-type-btn px-3 py-2 border rounded-md text-sm font-medium transition-colors bg-blue-50 border-blue-500 text-blue-700">
                                毎日
                            </button>
                            <button type="button" id="{{ form_id }}-type-weekly"
                                    onclick="setSchedule{{ config.endpoint_type|replace('_', '')|capitalize }}Type('weekly')"
                                    class="schedule-type-btn px-3 py-2 border rounded-md text-sm font-medium transition-colors bg-white border-gray-300 text-gray-700">
                                毎週
                            </button>
                            <button type="button" id="{{ form_id }}-type-monthly"
                                    onclick="setSchedule{{ config.endpoint_type|replace('_', '')|capitalize }}Type('monthly')"
                                    class="schedule-type-btn px-3 py-2 border rounded-md text-sm font-medium transition-colors bg-white border-gray-300 text-gray-700">
                                毎月
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">実行時刻（JST） <span class="text-red-500">*</span></label>
                            <input type="time" id="{{ form_id }}-time" name="execution_time" value="{{ config.default_time }}" required
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div id="{{ form_id }}-dow-container" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">実行曜日</label>
                            <select id="{{ form_id }}-dow" name="day_of_week"
                                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="0">月曜日</option>
                                <option value="1">火曜日</option>
                                <option value="2">水曜日</option>
                                <option value="3">木曜日</option>
                                <option value="4">金曜日</option>
                                <option value="5">土曜日</option>
                                <option value="6">日曜日</option>
                            </select>
                        </div>
                        
                        <div id="{{ form_id }}-dom-container" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">実行日</label>
                            <input type="number" id="{{ form_id }}-dom" name="day_of_month" value="1" min="1" max="31"
                                   placeholder="1-31"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- 有効/無効 -->
                <div class="flex items-center">
                    <input type="checkbox" id="{{ form_id }}-enabled" name="is_enabled" checked
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="{{ form_id }}-enabled" class="ml-2 block text-sm text-gray-900">
                        スケジュールを有効にする
                    </label>
                </div>
                {% endif %}
            </div>
            
            <!-- ボタン -->
            <div class="{% if is_simple %}px-6 py-4 bg-gray-50{% else %}pt-4 border-t border-gray-200{% endif %} flex justify-end space-x-3">
                <button type="button" onclick="closeSchedule{{ config.endpoint_type|replace('_', '')|capitalize }}{% if is_simple %}Modal{% else %}Form{% endif %}()"
                        class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    キャンセル
                </button>
                <button type="submit" id="{{ form_id }}-submit"
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                    保存
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// スケジュール管理関数を即座に定義
(function() {
    // {{ config.endpoint_type }}用スケジュール管理関数
        const endpointType = '{{ config.endpoint_type }}';
        const isSimple = {{ 'true' if is_simple else 'false' }};
        const containerId = '{{ container_id }}';
        const formId = '{{ form_id }}';
        const apiBaseUrl = '{{ config.api_base_url }}';
        
        let currentScheduleType = 'daily';
        let editingScheduleId = null;
    
    // フォーム/モーダルを開く
    const capitalizedType = endpointType.replace(/_/g, '').replace(/\b\w/g, l => l.toUpperCase());
    window['openSchedule' + capitalizedType + (isSimple ? 'Modal' : 'Form')] = function(scheduleData = null) {
        const container = document.getElementById(containerId);
        const title = document.getElementById(containerId + '-title');
        
        if (scheduleData) {
            // 編集モード
            editingScheduleId = scheduleData.id;
            title.textContent = isSimple ? '定期実行時間の変更' : '定期実行スケジュールを編集';
            
            document.getElementById(formId + '-schedule-id').value = scheduleData.id;
            
            if (isSimple) {
                // シンプルモード（企業同期）
                if (scheduleData.execution_time) {
                    const [hour, minute] = scheduleData.execution_time.split(':');
                    document.getElementById(formId + '-hour').value = parseInt(hour);
                    document.getElementById(formId + '-minute').value = parseInt(minute);
                }
            } else {
                // 詳細モード（日次株価）
                {% if config.show_name %}
                document.getElementById(formId + '-name').value = scheduleData.name || '';
                document.getElementById(formId + '-description').value = scheduleData.description || '';
                {% endif %}
                
                {% if config.show_relative_preset %}
                if (scheduleData.relative_preset) {
                    document.getElementById(formId + '-relative-preset').value = scheduleData.relative_preset;
                }
                {% endif %}
                
                const setTypeFuncName = 'setSchedule' + capitalizedType + 'Type';
                window[setTypeFuncName](scheduleData.schedule_type || 'daily');
                document.getElementById(formId + '-time').value = scheduleData.execution_time || '06:00';
                
                if (scheduleData.day_of_week !== null) {
                    document.getElementById(formId + '-dow').value = scheduleData.day_of_week;
                }
                if (scheduleData.day_of_month !== null) {
                    document.getElementById(formId + '-dom').value = scheduleData.day_of_month;
                }
                
                document.getElementById(formId + '-enabled').checked = scheduleData.is_enabled !== false;
            }
        } else {
            // 新規作成モード
            editingScheduleId = null;
            title.textContent = isSimple ? '定期実行時間の設定' : '新規定期実行スケジュール';
            document.getElementById(formId).reset();
            
            if (!isSimple) {
                const setTypeFuncName = 'setSchedule' + capitalizedType + 'Type';
                window[setTypeFuncName]('daily');
            }
        }
        
        if (isSimple) {
            container.classList.remove('hidden');
        } else {
            container.style.display = 'block';
        }
    };
    
    // フォーム/モーダルを閉じる
    window['closeSchedule' + capitalizedType + (isSimple ? 'Modal' : 'Form')] = function() {
        const container = document.getElementById(containerId);
        if (isSimple) {
            container.classList.add('hidden');
        } else {
            container.style.display = 'none';
        }
        editingScheduleId = null;
    };
    
    // スケジュールタイプを設定（詳細モードのみ）
    if (!isSimple) {
        const setScheduleTypeFuncName = 'setSchedule' + endpointType.replace(/_/g, '').replace(/\b\w/g, l => l.toUpperCase()) + 'Type';
        window[setScheduleTypeFuncName] = function(type) {
            currentScheduleType = type;
            
            // ボタンのスタイルを更新
            const container = document.getElementById(containerId);
            const buttons = container.querySelectorAll('.schedule-type-btn');
            buttons.forEach(btn => {
                if (btn.id === `${formId}-type-${type}`) {
                    btn.className = 'schedule-type-btn px-3 py-2 border rounded-md text-sm font-medium transition-colors bg-blue-50 border-blue-500 text-blue-700';
                } else {
                    btn.className = 'schedule-type-btn px-3 py-2 border rounded-md text-sm font-medium transition-colors bg-white border-gray-300 text-gray-700';
                }
            });
            
            // 曜日/日付選択の表示/非表示
            document.getElementById(formId + '-dow-container').style.display = type === 'weekly' ? 'block' : 'none';
            document.getElementById(formId + '-dom-container').style.display = type === 'monthly' ? 'block' : 'none';
        };
    }
    
    // フォーム送信
    window['submitSchedule' + capitalizedType + 'Form'] = async function(event) {
        event.preventDefault();
        
        const submitBtn = document.getElementById(formId + '-submit');
        submitBtn.disabled = true;
        submitBtn.textContent = '処理中...';
        
        try {
            let data = {};
            
            if (isSimple) {
                // シンプルモード（企業同期）
                const hour = document.getElementById(formId + '-hour').value;
                const minute = document.getElementById(formId + '-minute').value;
                data = {
                    hour: parseInt(hour),
                    minute: parseInt(minute)
                };
            } else {
                // 詳細モード（日次株価）
                data = {
                    {% if config.show_name %}
                    name: document.getElementById(formId + '-name').value,
                    description: document.getElementById(formId + '-description').value || null,
                    {% endif %}
                    sync_type: 'full',
                    {% if config.show_relative_preset %}
                    relative_preset: document.getElementById(formId + '-relative-preset').value,
                    {% endif %}
                    data_source_id: parseInt(document.querySelector('select[x-model="dataSourceId"]')?.value || '1'),
                    schedule_type: currentScheduleType,
                    execution_time: document.getElementById(formId + '-time').value,
                    day_of_week: currentScheduleType === 'weekly' ? parseInt(document.getElementById(formId + '-dow').value) : null,
                    day_of_month: currentScheduleType === 'monthly' ? parseInt(document.getElementById(formId + '-dom').value) : null,
                    is_enabled: document.getElementById(formId + '-enabled').checked
                };
            }
            
            const url = editingScheduleId 
                ? `${apiBaseUrl}/${editingScheduleId}`
                : apiBaseUrl;
            
            const method = editingScheduleId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                // 画面をリロードまたはHTMXで更新
                if (isSimple || !window.htmx) {
                    window.location.reload();
                } else {
                    htmx.trigger('#schedule-list-container', 'refresh-schedules');
                    window['closeSchedule' + capitalizedType + 'Form']();
                }
            } else {
                const error = await response.json();
                alert('エラー: ' + (error.detail || 'スケジュールの保存に失敗しました'));
            }
        } catch (error) {
            alert('エラー: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '保存';
        }
    };
    
    // 編集用の関数をグローバルに公開（詳細モードのみ）
    if (!isSimple) {
        window['editSchedule' + capitalizedType] = function(scheduleData) {
            window['openSchedule' + capitalizedType + 'Form'](scheduleData);
        };
    }
})();
</script>