# 上場銘柄一覧（listed_info）データ取得・格納機能 要件定義書

## 1. 概要
J-Quants API の上場銘柄一覧（listed_info）エンドポイントからデータを取得し、データベースに格納する機能を実装する。

## 2. 機能要件

### 2.1 データ取得機能
- J-Quants API の `/v1/listed/info` エンドポイントからデータを取得する
- 以下のパラメータに対応する：
  - `code`: 銘柄コード（オプション、 4 桁の数字）
  - `date`: 基準日（オプション、 YYYYMMDD または YYYY-MM-DD 形式）
- 認証ヘッダー（Authorization）を使用して API にアクセスする
- 全銘柄の一覧取得と特定銘柄の情報取得の両方に対応する

### 2.2 データ格納機能
- 取得したデータを PostgreSQL データベースに格納する
- 以下のフィールドを格納する：
  - Date: 基準日
  - Code: 銘柄コード
  - CompanyName: 会社名
  - CompanyNameEnglish: 会社名（英語）
  - Sector17Code: 17 業種コード
  - Sector17CodeName: 17 業種名
  - Sector33Code: 33 業種コード
  - Sector33CodeName: 33 業種名
  - ScaleCategory: 規模区分
  - MarketCode: 市場コード
  - MarketCodeName: 市場名
  - MarginCode: 信用区分（Standard/Premium プランのみ）
  - MarginCodeName: 信用区分名（Standard/Premium プランのみ）

### 2.3 更新機能
- 既存データがある場合は更新（UPSERT）処理を行う
- 銘柄コードと基準日の組み合わせで一意性を保証する

### 2.4 エラーハンドリング
- API 接続エラー、認証エラー、データ形式エラーを適切に処理する
- エラー発生時は詳細なログを出力する
- リトライ機能を実装する（最大 3 回）

## 3. 非機能要件

### 3.1 パフォーマンス
- 大量データ（約 4,000 銘柄）の一括取得・格納に対応
- バッチ処理による効率的なデータベース書き込み

### 3.2 信頼性
- トランザクション管理による一貫性の保証
- 部分的な失敗時のロールバック機能

### 3.3 拡張性
- 他の J-Quants API エンドポイントへの将来的な拡張を考慮した設計
- クリーンアーキテクチャに準拠した実装

## 4. 制約事項
- 既存のプロジェクト構造（クリーンアーキテクチャ）に準拠する
- 既存の認証機能（JQuantsAuthRepository）を活用する
- Python の型ヒントを使用する
- 十分なテストカバレッジ（80% 以上）を確保する

## 5. 成果物
- データ取得・格納機能の実装
- データベーステーブルの作成/マイグレーション
- ユニットテスト・統合テスト
- 使用方法のドキュメント