# タスクスケジューリング改善要件ファイル

## 背景

現在のシステムでは、 Celery Beat を使用してタスクスケジューリングを実装していますが、以下の課題があります。

### 現状の課題

1. **task_name の重複制限**
   - データベースレベルで `name` フィールドに UNIQUE 制約があるため、同じタスクを異なるパラメータで複数登録できない
   - 例：`fetch_listed_info_task_asyncpg` を「昨日分」と「過去 7 日分」で別々にスケジュールしたい場合、現在は不可能

2. **タスクのスケーラビリティ**
   - 新しいタスクタイプが追加された場合の管理方法が不明確
   - タスクの分類や整理の仕組みが不足

3. **パラメータ管理の柔軟性不足**
   - task_params として JSON で保存されているが、構造化された管理ができていない
   - 同一タスクの異なるパラメータ版を区別する仕組みがない

## 機能要件

### 1. 同一タスクの複数スケジュール登録

- **要件 ID**: FR-001
- **内容**: 同じ `task_name` を持つタスクを、異なるパラメータで複数スケジュール登録できるようにする
- **例**:
  - `fetch_listed_info_task_asyncpg` (period_type: "yesterday")
  - `fetch_listed_info_task_asyncpg` (period_type: "7days")
  - `fetch_listed_info_task_asyncpg` (period_type: "custom", from_date: "2024-01-01", to_date: "2024-01-31")

### 2. タスクの分類と管理

- **要件 ID**: FR-002
- **内容**: タスクをカテゴリーやタグで分類できるようにする
- **例**:
  - カテゴリー: "data_fetch", "analysis", "notification", "maintenance"
  - タグ: ["jquants", "daily", "critical"]

### 3. スケジュール名の自動生成オプション

- **要件 ID**: FR-003
- **内容**: ユーザーが名前を指定しない場合、タスク名とパラメータから意味のある名前を自動生成する
- **例**: `fetch_listed_info_yesterday_daily`, `fetch_listed_info_7days_weekly`

### 4. タスクパラメータのバリデーション

- **要件 ID**: FR-004
- **内容**: タスクごとに必須パラメータと型を定義し、登録時にバリデーションを行う
- **例**: `fetch_listed_info_task_asyncpg` の場合、`period_type` は必須で、値は特定の選択肢のみ許可

### 5. スケジュールの重複実行防止

- **要件 ID**: FR-005
- **内容**: 同じタスクが同じパラメータで既に実行中の場合、新しい実行をスキップまたはキューイングする
- **設定可能なオプション**:
  - skip: 実行中なら新しい実行をスキップ
  - queue: 実行中なら完了後に実行
  - allow: 並行実行を許可（デフォルト）

### 6. タスク実行履歴との連携強化

- **要件 ID**: FR-006
- **内容**: どのスケジュールから実行されたタスクかを追跡できるようにする
- **実装**: TaskExecutionLog に schedule_name フィールドを追加

## 非機能要件

### 1. パフォーマンス

- **要件 ID**: NFR-001
- **内容**: スケジュール数が増えても、 Beat のパフォーマンスが劣化しないこと
- **目標**: 1000 個のスケジュールでも 1 秒以内に次回実行時刻を計算

### 2. 運用性

- **要件 ID**: NFR-002
- **内容**: 管理画面や API で簡単にスケジュールを管理できること
- **機能**:
  - スケジュールの一覧表示（フィルタリング、検索機能付き）
  - スケジュールの有効/無効切り替え
  - 実行履歴の確認

## 制約事項

1. Celery Beat の基本的なアーキテクチャは維持する
2. PostgreSQL のデータベーススキーマ変更は最小限に抑える
3. 既存の API エンドポイントは後方互換性を保つ

## 成功基準

1. 同一タスクを異なるパラメータで複数スケジュール登録できる
2. 既存のスケジュールが問題なく動作し続ける
3. 新しいタスクタイプの追加が容易になる
4. 運用チームがスケジュールを効率的に管理できる

## 対象外

1. Celery Worker の改修
2. タスク実行エンジン自体の変更
3. 分散スケジューラーの実装（Beat は引き続き単一インスタンスで動作）