# CompanySyncService リファクタリング要件書

## 1. 概要
`CompanySyncService`クラスのリファクタリングを行い、責務の分離とコードの保守性向上を図ります。

## 2. 現状の課題

### 2.1 CompanySyncServiceの問題点
- **責務の混在**: 1つのクラスに以下の責務が混在
  - J-Quants APIからのデータ取得制御
  - データ形式の変換・マッピング
  - データベースへの保存処理
  - エラーハンドリング
  - 同期履歴の管理
- **メソッドの肥大化**: 
  - `sync_companies`メソッド: 185行
  - `_save_companies_data`メソッド: 60行
- **テストの困難さ**: 外部依存が密結合でモックが困難

### 2.2 具体的な問題箇所
- データ変換ロジックが`_map_jquants_data_to_model`に集中
- DB操作が各メソッドに散在
- エラーハンドリングが統一されていない
- 同期処理とシンプル同期で重複コード

## 3. リファクタリングの要件

### 3.1 機能要件
- 既存の全機能を維持すること
- 既存のAPIインターフェースを変更しないこと
- データ同期の精度を保つこと

### 3.2 非機能要件
- **単一責任の原則**: 各クラスが1つの責務のみを持つ
- **テスタビリティ**: 依存性注入によるテストの容易化
- **可読性**: メソッドを50行以内に収める
- **再利用性**: 共通処理の抽出

### 3.3 リファクタリング方針
1. **責務の分離**
   - データ取得: `CompanyDataFetcher`
   - データ変換: `CompanyDataMapper`
   - DB操作: `CompanyRepository`
   - 同期制御: `CompanySyncService`（調整役）

2. **インターフェースの導入**
   - 各コンポーネント間の依存を抽象化

3. **エラーハンドリングの統一**
   - 共通のエラーハンドラーを使用

### 3.4 制約事項
- データベーススキーマの変更は行わない
- 既存APIのインターフェースは変更しない
- 段階的なリファクタリングを行う

### 3.5 対象外
- 株価データ取得機能との共通化は今回のスコープ外
- 共通化は次フェーズで検討

## 4. 成功基準
- CompanySyncServiceの責務が明確に分離されること
- 各メソッドが50行以内に収まること
- 単体テストが容易に書けること
- 既存の機能が全て正常に動作すること

## 5. リスクと対策
- **リスク**: リファクタリング中の不具合導入
- **対策**: 
  - 既存のテストを先に充実させる
  - 小さな変更を段階的に適用
  - 各段階でのテスト実行

## 5. リスクと対策
- **リスク**: リファクタリング中の不具合導入
- **対策**: 包括的なテストの作成と段階的なリリース