# 実装計画: Docker 環境での Redis Sync 設定問題の解決

## 実装フェーズと優先順位

### フェーズ 1: 診断ツールの作成（最優先）
**目的**: 現在の問題を正確に把握する

#### 1.1 診断スクリプトの作成
- **ファイル**: `scripts/diagnose_redis_sync_docker.py`
- **機能**:
  - 環境変数の確認（CELERY_BEAT_REDIS_SYNC 関連）
  - Redis 接続テスト（各コンテナから）
  - Celery Beat 設定の確認
  - Redis パブリッシュ/サブスクライブのテスト
- **所要時間**: 30 分

#### 1.2 Docker 環境変数確認スクリプト
- **ファイル**: `scripts/check_docker_env.sh`
- **機能**: 各コンテナ内の環境変数を確認
- **所要時間**: 15 分

### フェーズ 2: ログ出力の改善
**目的**: デバッグを容易にする

#### 2.1 DatabaseSchedulerAsyncPG のログ改善
- **ファイル**: `app/infrastructure/celery/schedulers/database_scheduler_asyncpg.py`
- **変更内容**:
  - `__init__`メソッドで環境変数の状態をログ出力
  - Redis 接続時の詳細なログ
  - エラー時のスタックトレース出力
- **所要時間**: 20 分

#### 2.2 ScheduleEventPublisher のログ改善
- **ファイル**: `app/infrastructure/celery/schedule_event_publisher.py`
- **変更内容**:
  - パブリッシュ成功/失敗の詳細なログ
  - Redis 接続状態のログ
- **所要時間**: 15 分

### フェーズ 3: Docker Compose 設定の修正
**目的**: 環境変数を確実に渡す

#### 3.1 docker-compose.yml の更新
- **変更内容**:
  - celery-beat サービスに環境変数を明示的に追加
  - app サービスにも同様の環境変数を追加
- **所要時間**: 15 分

#### 3.2 docker-compose.dev.yml の更新
- **変更内容**:
  - 開発環境用の追加設定
- **所要時間**: 10 分

### フェーズ 4: テストと検証
**目的**: 問題が解決したことを確認

#### 4.1 統合テストスクリプトの作成
- **ファイル**: `scripts/test_docker_redis_sync.py`
- **機能**:
  - 診断の実行
  - スケジュール作成とイベント確認
  - 実行履歴の取得確認
- **所要時間**: 30 分

#### 4.2 既存テストスクリプトの動作確認
- `test_scheduled_listed_info_api.py`の実行
- 実行履歴が正常に取得できることを確認
- **所要時間**: 15 分

## 実装手順

### ステップ 1: 現状把握（フェーズ 1）
1. 診断スクリプトを作成
2. Docker 環境で診断を実行
3. 問題の原因を特定

### ステップ 2: 修正実装（フェーズ 2-3）
1. ログ出力を改善
2. Docker Compose 設定を修正
3. 各変更後に動作確認

### ステップ 3: 検証（フェーズ 4）
1. 統合テストを実行
2. 既存のテストスクリプトで動作確認
3. ドキュメントの更新

## リスク管理

### 潜在的リスク
1. **既存機能への影響**
   - 対策: 変更は最小限に留め、ログ出力と設定のみ修正
   
2. **環境差異による動作不良**
   - 対策: ローカル環境でも動作確認を実施

3. **パフォーマンスへの影響**
   - 対策: ログ出力は必要最小限に留める

### ロールバック計画
- Git での変更管理により、問題発生時は即座にロールバック可能
- 各フェーズ完了後にコミットを作成

## 成功基準
1. Docker 環境で`test_scheduled_listed_info_api.py`が正常に完了
2. Celery Beat ログで Redis Sync 関連のメッセージが確認できる
3. スケジュール作成から 1 分以内に実行履歴が取得できる

## タイムライン
- **総所要時間**: 約 2.5 時間
- **フェーズ 1**: 45 分
- **フェーズ 2**: 35 分
- **フェーズ 3**: 25 分
- **フェーズ 4**: 45 分