# Domain 層クリーンアーキテクチャ分析・改善要件

## 概要
本プロジェクトの domain 層をクリーンアーキテクチャの原則に基づいて分析し、改善点を洗い出して実装する。

## 目的
- クリーンアーキテクチャの原則に従った domain 層の実装
- ビジネスロジックの適切な配置と凝集性の向上
- 外部依存の排除によるテスタビリティの向上
- 保守性と拡張性の向上

## 現状の問題点

### 1. リポジトリインターフェースの重複
- `schedule_repository.py`と`schedule_repository_interface.py`の 2 つのインターフェースが存在
- メソッドシグネチャも異なり、混乱を招く可能性がある

### 2. エンティティの外部依存
- `ListedInfo`エンティティの`from_dict()`メソッドが J-Quants API のデータ構造に直接依存
- ドメイン層が外部 API の仕様変更の影響を受ける

### 3. 貧血症ドメインモデル
- エンティティがほぼデータホルダーとしてのみ機能
- ビジネスロジックがユースケースに集中している可能性
- ドメインサービスディレクトリが空

### 4. プレゼンテーション層の関心事の混入
- `Schedule`エンティティの`to_dict()`メソッド
- シリアライゼーションはドメイン層の責務ではない

### 5. ドメインイベントの未実装
- イベント駆動アーキテクチャのためのドメインイベントが定義されていない

## 改善要件

### 1. リポジトリインターフェースの統一
- 重複するインターフェースを統一
- 命名規則を明確化（`XxxRepositoryInterface`で統一）
- すべてのリポジトリ実装がインターフェースに準拠していることを確認

### 2. エンティティの純粋性の確保
- `from_dict()`メソッドをファクトリーまたはマッパーに移動
- エンティティは純粋なビジネスロジックのみを含む
- 外部 API のデータ構造からの変換はアプリケーション層で実施

### 3. リッチドメインモデルへの移行
- ビジネスロジックをエンティティに移動
- 必要に応じてドメインサービスを実装
- エンティティの振る舞いを充実させる

### 4. 適切な責務分離
- `to_dict()`メソッドを DTO またはプレゼンターに移動
- ドメイン層は純粋なビジネスロジックのみを含む

### 5. ドメインイベントの実装
- 重要なビジネスイベントをドメインイベントとして定義
- イベント発行の仕組みを構築

## 受け入れ条件
- [ ] すべてのリポジトリインターフェースが統一された命名規則に従っている
- [ ] エンティティが外部依存を持たない
- [ ] ビジネスロジックが適切にエンティティまたはドメインサービスに配置されている
- [ ] シリアライゼーション関連のメソッドがドメイン層から除去されている
- [ ] 既存のテストがすべてパスする
- [ ] 新しい設計に対するテストが追加されている

## 制約事項
- 既存の API インターフェースは変更しない
- データベーススキーマは変更しない
- 段階的な移行を可能にする（ビッグバンリリースは避ける）

## 非機能要件
- パフォーマンスの劣化を避ける
- 既存機能への影響を最小限にする
- コードの可読性を向上させる