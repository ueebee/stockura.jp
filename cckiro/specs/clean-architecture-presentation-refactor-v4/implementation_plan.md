# Presentation 層クリーンアーキテクチャ改善 第 4 回 実装計画書

## 1. 実装計画概要

本実装計画書では、設計書に基づいて具体的な実装タスクと手順を定義します。
各フェーズで動作確認可能な状態を維持しながら、段階的に実装を進めます。

## 2. Phase 1: 基盤整備（例外クラスとレスポンス構造）

### 2.1 例外クラスの実装

#### タスク 1: 基底例外クラスの作成
- **ファイル**: `app/presentation/exceptions/base.py`
- **作業内容**:
  1. ディレクトリ `app/presentation/exceptions/` を作成
  2. `__init__.py` を作成
  3. 基底例外クラス `PresentationError` を実装
  4. `ValidationError` と `ResourceNotFoundError` を実装

#### タスク 2: HTTP 例外マッピングの実装
- **ファイル**: `app/presentation/exceptions/http_exceptions.py`
- **作業内容**:
  1. エラーコードと HTTP ステータスコードのマッピング定義
  2. 変換関数 `presentation_error_to_http_exception` の実装

### 2.2 統一レスポンス構造の実装

#### タスク 3: レスポンススキーマの作成
- **ファイル**: `app/presentation/schemas/responses.py`
- **作業内容**:
  1. `BaseResponse` ジェネリッククラスの実装
  2. `SuccessResponse` と `ErrorResponse` の実装
  3. `PaginatedResponse` の実装

#### タスク 4: エラースキーマの作成
- **ファイル**: `app/presentation/schemas/errors.py`
- **作業内容**:
  1. エラー詳細スキーマの定義
  2. 検証エラー用のスキーマ定義

**Phase 1 完了後の確認項目**:
- 例外クラスが import 可能
- レスポンススキーマが Pydantic で正しく動作
- 既存コードへの影響なし

## 3. Phase 2: ミドルウェア実装

### 3.1 エラーハンドリングミドルウェア

#### タスク 5: エラーハンドリングミドルウェアの実装
- **ファイル**: `app/presentation/middleware/error_handler.py`
- **作業内容**:
  1. `ErrorHandlingMiddleware` クラスの実装
  2. PresentationError の捕捉と変換
  3. 予期しないエラーの処理

### 3.2 ロギングミドルウェア

#### タスク 6: ロギングミドルウェアの実装
- **ファイル**: `app/presentation/middleware/logging.py`
- **作業内容**:
  1. `RequestLoggingMiddleware` クラスの実装
  2. リクエスト/レスポンスのロギング
  3. 処理時間の計測

### 3.3 ミドルウェアの登録

#### タスク 7: FastAPI アプリケーションへのミドルウェア登録
- **ファイル**: `app/main.py` または適切な初期化ファイル
- **作業内容**:
  1. ミドルウェアのインポート
  2. app.add_middleware() での登録
  3. 登録順序の調整

**Phase 2 完了後の確認項目**:
- API リクエストがミドルウェアを通過
- ログが正しく出力される
- エラーが適切にハンドリングされる

## 4. Phase 3: API 層への適用

### 4.1 サンプルエンドポイントでの検証

#### タスク 8: 1 つのエンドポイントで統一レスポンス構造を試験
- **ファイル**: `app/presentation/api/v1/endpoints/schedules.py`の 1 エンドポイント
- **作業内容**:
  1. `list_schedules` エンドポイントを選択
  2. レスポンスを統一構造でラップ
  3. 動作確認とテスト

### 4.2 全エンドポイントへの適用

#### タスク 9: schedules.py の残りのエンドポイントへ適用
- **作業内容**:
  1. 各エンドポイントのレスポンスを統一構造に変更
  2. エラーハンドリングの統一
  3. Mapper パターンとの整合性確認

#### タスク 10: その他のエンドポイントへの適用
- **対象ファイル**: 
  - `app/presentation/api/v1/endpoints/auth.py`
  - `app/presentation/api/v1/endpoints/listed_info_schedules.py`
- **作業内容**:
  1. 各エンドポイントの段階的移行
  2. 既存テストの修正

**Phase 3 完了後の確認項目**:
- すべての API エンドポイントが統一レスポンス構造を使用
- 既存クライアントとの互換性維持
- API ドキュメント（Swagger）の更新

## 5. Phase 4: CLI 層への適用

### 5.1 CLI エラーハンドラーの実装

#### タスク 11: CLI エラーハンドラーの作成
- **ファイル**: `app/presentation/cli/error_handler.py`
- **作業内容**:
  1. `handle_cli_errors` デコレーターの実装
  2. エラーメッセージのフォーマット定義
  3. 終了コードの設定

### 5.2 CLI コマンドへの適用

#### タスク 12: fetch_listed_info_command への適用
- **ファイル**: `app/presentation/cli/commands/fetch_listed_info_command.py`
- **作業内容**:
  1. エラーハンドラーデコレーターの適用
  2. 例外の適切な変換
  3. ユーザーフレンドリーなメッセージ

#### タスク 13: migration_command への適用
- **ファイル**: `app/presentation/cli/commands/migration_command.py`
- **作業内容**:
  1. 同様のエラーハンドリング適用
  2. マイグレーション固有のエラー処理

**Phase 4 完了後の確認項目**:
- CLI コマンドのエラーが適切に表示
- 終了コードが正しく設定
- 既存の動作との互換性

## 6. Phase 5: 検証とテスト

### 6.1 入力検証の整理

#### タスク 14: 検証デコレーターの実装
- **ファイル**: `app/presentation/schemas/validators.py`
- **作業内容**:
  1. `validate_request` デコレーターの実装
  2. Pydantic 検証エラーの統一フォーマット化

### 6.2 テストの追加・修正

#### タスク 15: ユニットテストの追加
- **対象**:
  - 例外クラスのテスト
  - レスポンス構造のテスト
  - ミドルウェアのテスト

#### タスク 16: 統合テストの修正
- **作業内容**:
  1. 新しいレスポンス構造に対応したテスト修正
  2. エラーケースのテスト追加

**Phase 5 完了後の確認項目**:
- すべてのテストが通過
- カバレッジの維持・向上
- ドキュメントの更新

## 7. リスクと対策

### 7.1 後方互換性
- **リスク**: 既存クライアントが新しいレスポンス構造に対応できない
- **対策**: データは`data`フィールドに格納し、段階的移行を可能にする

### 7.2 パフォーマンス
- **リスク**: ミドルウェアによるオーバーヘッド
- **対策**: 必要最小限の処理に留め、非同期処理を活用

### 7.3 複雑性の増加
- **リスク**: 過度な抽象化による理解困難性
- **対策**: シンプルな設計を心がけ、適切なドキュメント化

## 8. 完了基準

- [ ] Phase 1: 基盤となる例外クラスとレスポンス構造が実装されている
- [ ] Phase 2: ミドルウェアが正しく動作している
- [ ] Phase 3: すべての API エンドポイントが統一構造を使用
- [ ] Phase 4: CLI コマンドに統一的なエラーハンドリングが適用
- [ ] Phase 5: 検証が整理され、すべてのテストが通過
- [ ] ドキュメントが更新されている
- [ ] パフォーマンスへの影響が許容範囲内

## 9. 次のステップ

実装完了後、以下を検討：
- 認証ミドルウェアの実装
- レート制限ミドルウェアの追加
- より高度なロギング（構造化ログ、分散トレーシング）
- API バージョニング戦略の具体化