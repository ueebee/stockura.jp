# Celery Beat タスク実行問題修正の要件

## 問題の概要

Docker 環境で Celery Beat がスケジュールを正しく読み込み、`is_due=True`を返しているにも関わらず、タスクがワーカーに送信されていない問題を解決する。

## 現状の問題点

1. **カスタムスケジューラーの問題**
   - `DatabaseSchedulerAsyncPG`クラスがスケジュールを正しく読み込んでいる
   - `is_due()`メソッドが正しく`True`を返している
   - しかし、タスクが Celery ワーカーに送信されていない

2. **根本原因**
   - 親クラス（`Scheduler`）の`tick()`メソッドがタスクを送信する際に必要な情報が不足している可能性
   - `apply_entry()`メソッドが正しく呼ばれていない、または正しく実装されていない
   - `last_run_at`の管理が正しくない

## 要件

### 1. 必須要件

1. **タスクの確実な実行**
   - スケジュールに従ってタスクが確実にワーカーに送信される
   - `is_due=True`となったタスクが漏れなく実行される

2. **既存機能の維持**
   - データベースからのスケジュール読み込み機能を維持
   - 非同期データベース接続（asyncpg）の使用を継続
   - 60 秒ごとのスケジュール再読み込み機能を維持

3. **ログとモニタリング**
   - タスク送信時の詳細なログ出力
   - エラー発生時の適切なエラーハンドリングとログ出力

### 2. 実装要件

1. **ScheduleEntry の完全な実装**
   - `apply_entry()`メソッドの実装または修正
   - `last_run_at`の適切な更新処理
   - タスク送信後の状態管理

2. **互換性の確保**
   - Celery 標準の Scheduler クラスとの互換性維持
   - 既存のタスク定義（`fetch_listed_info_task_asyncpg`）との互換性

3. **テスト可能性**
   - 手動でのタスク実行テストが可能
   - スケジュール動作の検証が可能

### 3. 非機能要件

1. **パフォーマンス**
   - タスクスケジューリングのオーバーヘッドを最小限に抑える
   - データベース接続の効率的な管理

2. **信頼性**
   - タスクの重複実行を防ぐ
   - スケジューラーの異常終了時の適切な復旧

3. **保守性**
   - コードの可読性と理解しやすさ
   - 将来的な拡張や修正が容易な設計

## 制約事項

1. 既存のデータベーススキーマ（`celery_beat_schedules`テーブル）を変更しない
2. 既存のタスク定義を変更しない
3. Docker 環境での動作を前提とする

## 成功基準

1. スケジュールに登録されたタスクが指定時刻に実行される
2. Flower でタスクの実行状況が確認できる
3. `task_execution_logs`テーブルにタスク実行ログが記録される
4. エラー発生時に適切なログが出力される