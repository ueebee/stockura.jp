# aiohttp セッションクローズエラー修正の要件定義書

## 1. 概要
Celery タスク実行時に aiohttp クライアントセッションが適切にクローズされず、警告メッセージが表示される問題を修正します。

## 2. 問題の詳細
### 2.1 現象
- Celery ワーカーのログに以下のエラーメッセージが出力される：
  ```
  Unclosed client session
  client_session: <aiohttp.client.ClientSession object at 0xe850640967d0>
  ```

### 2.2 影響
- メモリリーク：未解放のセッションがメモリを消費し続ける
- 接続リーク：HTTP 接続が適切にクローズされない
- パフォーマンス低下：長時間稼働するとリソースが枯渇する可能性

## 3. 機能要件
### 3.1 セッション管理
- [ ] J-Quants API への HTTP リクエストで使用する aiohttp セッションを適切に管理
- [ ] API リクエスト完了後、必ずセッションをクローズ
- [ ] 例外発生時もセッションが確実にクローズされることを保証

### 3.2 エラーハンドリング
- [ ] セッションクローズ処理でエラーが発生してもタスクの結果に影響しない
- [ ] セッション管理のエラーは適切にログ出力される

### 3.3 パフォーマンス
- [ ] セッションの作成・破棄のオーバーヘッドを最小限に抑える
- [ ] 可能であればセッションの再利用を検討

## 4. 非機能要件
### 4.1 互換性
- [ ] 既存の J-Quants API 認証フローに影響を与えない
- [ ] 現在のタスク実行ロジックを変更しない

### 4.2 保守性
- [ ] セッション管理のコードは理解しやすく、メンテナンスしやすい
- [ ] 将来的な拡張（接続プール設定など）に対応できる構造

### 4.3 監視性
- [ ] セッションの状態を確認できるログを適切に出力
- [ ] 問題発生時に原因を特定しやすいエラーメッセージ

## 5. 制約事項
- Celery ワーカーのフォークプロセスモデルでの動作を考慮
- asyncio イベントループとの統合を適切に行う
- 既存の Redis 認証リポジトリとの整合性を保つ

## 6. 完了条件
- [ ] Celery ワーカーログに「 Unclosed client session 」警告が出なくなる
- [ ] J-Quants API へのリクエストが正常に動作する
- [ ] タスク実行のパフォーマンスが維持される
- [ ] 新しいセッション管理のテストが成功する