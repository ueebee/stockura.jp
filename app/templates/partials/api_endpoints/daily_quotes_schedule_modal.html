<!-- 日次株価データ定期実行スケジュール設定モーダル -->
<div id="daily-quotes-schedule-modal" 
     class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity hidden z-50"
     x-data="dailyQuotesScheduleManager()"
     x-show="isOpen"
     x-cloak>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl"
                 @click.outside="closeModal()">
                
                <!-- ヘッダー -->
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">定期実行スケジュール設定</h3>
                        <button @click="closeModal()" class="text-gray-400 hover:text-gray-500">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- フォーム -->
                    <form @submit.prevent="saveSchedule" class="space-y-4">
                        <!-- スケジュール名 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">スケジュール名</label>
                            <input type="text" x-model="scheduleName" required
                                   placeholder="例: 日次更新（過去7日間）"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <!-- 説明 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">説明（任意）</label>
                            <textarea x-model="description" rows="2"
                                      placeholder="例: 毎朝6時に過去7日間のデータを取得"
                                      class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        
                        <!-- データソース選択 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">データソース</label>
                            <select x-model="dataSourceId" required
                                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                {% for ds in data_sources %}
                                {% if ds.provider_type == 'jquants' and ds.is_enabled %}
                                <option value="{{ ds.id }}">{{ ds.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- 同期タイプ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">同期タイプ</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button"
                                        @click="syncType = 'incremental'"
                                        :class="{'bg-blue-50 border-blue-500 text-blue-700': syncType === 'incremental', 'bg-white border-gray-300 text-gray-700': syncType !== 'incremental'}"
                                        class="px-3 py-2 border rounded-md text-sm font-medium transition-colors">
                                    特定日（前日のみ）
                                </button>
                                <button type="button"
                                        @click="syncType = 'full'"
                                        :class="{'bg-blue-50 border-blue-500 text-blue-700': syncType === 'full', 'bg-white border-gray-300 text-gray-700': syncType !== 'full'}"
                                        class="px-3 py-2 border rounded-md text-sm font-medium transition-colors">
                                    期間指定
                                </button>
                            </div>
                        </div>
                        
                        <!-- 期間設定（期間指定モードの場合） -->
                        <div x-show="syncType === 'full'" x-transition>
                            <label class="block text-sm font-medium text-gray-700 mb-2">取得期間</label>
                            <select x-model="relativePreset" required
                                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="yesterday">前日のみ</option>
                                <option value="last7days">実行日から過去7日間</option>
                                <option value="last30days">実行日から過去30日間</option>
                                <option value="last90days">実行日から過去90日間</option>
                                <option value="thisMonth">実行月の1日から前日まで</option>
                                <option value="lastMonth">前月全体</option>
                            </select>
                        </div>
                        
                        <!-- スケジュールタイプ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">実行頻度</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button type="button"
                                        @click="scheduleType = 'daily'"
                                        :class="{'bg-blue-50 border-blue-500 text-blue-700': scheduleType === 'daily', 'bg-white border-gray-300 text-gray-700': scheduleType !== 'daily'}"
                                        class="px-3 py-2 border rounded-md text-sm font-medium transition-colors">
                                    毎日
                                </button>
                                <button type="button"
                                        @click="scheduleType = 'weekly'"
                                        :class="{'bg-blue-50 border-blue-500 text-blue-700': scheduleType === 'weekly', 'bg-white border-gray-300 text-gray-700': scheduleType !== 'weekly'}"
                                        class="px-3 py-2 border rounded-md text-sm font-medium transition-colors">
                                    毎週
                                </button>
                                <button type="button"
                                        @click="scheduleType = 'monthly'"
                                        :class="{'bg-blue-50 border-blue-500 text-blue-700': scheduleType === 'monthly', 'bg-white border-gray-300 text-gray-700': scheduleType !== 'monthly'}"
                                        class="px-3 py-2 border rounded-md text-sm font-medium transition-colors">
                                    毎月
                                </button>
                            </div>
                        </div>
                        
                        <!-- 実行時刻 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">実行時刻（JST）</label>
                            <input type="time" x-model="executionTime" required
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <!-- 曜日選択（週次の場合） -->
                        <div x-show="scheduleType === 'weekly'" x-transition>
                            <label class="block text-sm font-medium text-gray-700 mb-2">実行曜日</label>
                            <select x-model="dayOfWeek" required
                                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="0">月曜日</option>
                                <option value="1">火曜日</option>
                                <option value="2">水曜日</option>
                                <option value="3">木曜日</option>
                                <option value="4">金曜日</option>
                                <option value="5">土曜日</option>
                                <option value="6">日曜日</option>
                            </select>
                        </div>
                        
                        <!-- 日付選択（月次の場合） -->
                        <div x-show="scheduleType === 'monthly'" x-transition>
                            <label class="block text-sm font-medium text-gray-700 mb-2">実行日</label>
                            <input type="number" x-model="dayOfMonth" min="1" max="31" required
                                   placeholder="1-31"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <!-- 有効/無効 -->
                        <div class="flex items-center">
                            <input type="checkbox" x-model="isEnabled" id="schedule-enabled"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="schedule-enabled" class="ml-2 block text-sm text-gray-900">
                                スケジュールを有効にする
                            </label>
                        </div>
                    </form>
                </div>
                
                <!-- フッター -->
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <button type="submit" @click="saveSchedule"
                            :disabled="isProcessing"
                            class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 sm:ml-3 sm:w-auto disabled:opacity-50">
                        <span x-show="!isProcessing">保存</span>
                        <span x-show="isProcessing">処理中...</span>
                    </button>
                    <button type="button" @click="closeModal()"
                            class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function dailyQuotesScheduleManager() {
    return {
        isOpen: false,
        isProcessing: false,
        scheduleId: null,
        scheduleName: '',
        description: '',
        dataSourceId: 1,
        syncType: 'incremental',
        relativePreset: 'yesterday',
        scheduleType: 'daily',
        executionTime: '06:00',
        dayOfWeek: 0,
        dayOfMonth: 1,
        isEnabled: true,
        
        openModal(scheduleData = null) {
            if (scheduleData) {
                // 編集モード
                this.scheduleId = scheduleData.id;
                this.scheduleName = scheduleData.name;
                this.description = scheduleData.description || '';
                this.dataSourceId = scheduleData.data_source_id;
                this.syncType = scheduleData.sync_type;
                this.relativePreset = scheduleData.relative_preset || 'yesterday';
                this.scheduleType = scheduleData.schedule_type;
                this.executionTime = scheduleData.execution_time;
                this.dayOfWeek = scheduleData.day_of_week || 0;
                this.dayOfMonth = scheduleData.day_of_month || 1;
                this.isEnabled = scheduleData.is_enabled;
            } else {
                // 新規作成モード
                this.resetForm();
            }
            this.isOpen = true;
        },
        
        closeModal() {
            this.isOpen = false;
            this.resetForm();
        },
        
        resetForm() {
            this.scheduleId = null;
            this.scheduleName = '';
            this.description = '';
            this.dataSourceId = 1;
            this.syncType = 'incremental';
            this.relativePreset = 'yesterday';
            this.scheduleType = 'daily';
            this.executionTime = '06:00';
            this.dayOfWeek = 0;
            this.dayOfMonth = 1;
            this.isEnabled = true;
            this.isProcessing = false;
        },
        
        async saveSchedule() {
            if (this.isProcessing) return;
            
            this.isProcessing = true;
            
            try {
                const data = {
                    name: this.scheduleName,
                    description: this.description || null,
                    sync_type: this.syncType,
                    relative_preset: this.syncType === 'full' ? this.relativePreset : null,
                    data_source_id: this.dataSourceId,
                    schedule_type: this.scheduleType,
                    execution_time: this.executionTime,
                    day_of_week: this.scheduleType === 'weekly' ? parseInt(this.dayOfWeek) : null,
                    day_of_month: this.scheduleType === 'monthly' ? parseInt(this.dayOfMonth) : null,
                    is_enabled: this.isEnabled
                };
                
                const url = this.scheduleId 
                    ? `/api/v1/daily-quotes/schedules/${this.scheduleId}`
                    : '/api/v1/daily-quotes/schedules';
                
                const method = this.scheduleId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    // スケジュール一覧を更新
                    htmx.trigger('#schedule-list-container', 'refresh-schedules');
                    this.closeModal();
                } else {
                    const error = await response.json();
                    alert('エラー: ' + (error.detail || 'スケジュールの保存に失敗しました'));
                }
            } catch (error) {
                alert('エラー: ' + error.message);
            } finally {
                this.isProcessing = false;
            }
        }
    };
}
</script>