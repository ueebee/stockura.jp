<!-- 日次株価データ定期実行スケジュール設定フォーム（シンプル版） -->
<div id="schedule-form-container" style="display: none;" class="bg-gray-50 border border-gray-200 rounded-lg p-6 mt-4">
    <div class="flex items-center justify-between mb-4">
        <h4 class="text-lg font-semibold text-gray-900" id="form-title">新規定期実行スケジュール</h4>
        <button onclick="closeScheduleForm()" class="text-gray-400 hover:text-gray-500">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
    
    <form id="schedule-form" onsubmit="submitScheduleForm(event)" class="space-y-4">
        <input type="hidden" id="schedule-id">
        
        <!-- スケジュール名 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">スケジュール名 <span class="text-red-500">*</span></label>
                <input type="text" id="schedule-name" required
                       placeholder="例: 日次更新（過去7日間）"
                       class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">説明（任意）</label>
                <input type="text" id="schedule-description"
                       placeholder="例: 毎朝6時に過去7日間のデータを取得"
                       class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
        
        <!-- 同期設定 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">取得期間 <span class="text-red-500">*</span></label>
                <select id="relative-preset" required
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="yesterday">前日のみ</option>
                    <option value="last7days" selected>実行日から過去7日間</option>
                    <option value="last30days">実行日から過去30日間</option>
                    <option value="last90days">実行日から過去90日間</option>
                    <option value="thisMonth">実行月の1日から前日まで</option>
                    <option value="lastMonth">前月全体</option>
                </select>
            </div>
        </div>
        
        <!-- スケジュール設定 -->
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">実行頻度</label>
                <div class="grid grid-cols-3 gap-2">
                    <button type="button" id="schedule-type-daily"
                            onclick="setScheduleType('daily')"
                            class="schedule-type-btn px-3 py-2 border rounded-md text-sm font-medium transition-colors bg-blue-50 border-blue-500 text-blue-700">
                        毎日
                    </button>
                    <button type="button" id="schedule-type-weekly"
                            onclick="setScheduleType('weekly')"
                            class="schedule-type-btn px-3 py-2 border rounded-md text-sm font-medium transition-colors bg-white border-gray-300 text-gray-700">
                        毎週
                    </button>
                    <button type="button" id="schedule-type-monthly"
                            onclick="setScheduleType('monthly')"
                            class="schedule-type-btn px-3 py-2 border rounded-md text-sm font-medium transition-colors bg-white border-gray-300 text-gray-700">
                        毎月
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">実行時刻（JST） <span class="text-red-500">*</span></label>
                    <input type="time" id="execution-time" value="06:00" required
                           class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div id="day-of-week-container" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">実行曜日</label>
                    <select id="day-of-week"
                            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="0">月曜日</option>
                        <option value="1">火曜日</option>
                        <option value="2">水曜日</option>
                        <option value="3">木曜日</option>
                        <option value="4">金曜日</option>
                        <option value="5">土曜日</option>
                        <option value="6">日曜日</option>
                    </select>
                </div>
                
                <div id="day-of-month-container" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">実行日</label>
                    <input type="number" id="day-of-month" value="1" min="1" max="31"
                           placeholder="1-31"
                           class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
        </div>
        
        <!-- 有効/無効 -->
        <div class="flex items-center">
            <input type="checkbox" id="schedule-enabled" checked
                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
            <label for="schedule-enabled" class="ml-2 block text-sm text-gray-900">
                スケジュールを有効にする
            </label>
        </div>
        
        <!-- ボタン -->
        <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
            <button type="button" onclick="closeScheduleForm()"
                    class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                キャンセル
            </button>
            <button type="submit" id="submit-btn"
                    class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                保存
            </button>
        </div>
    </form>
</div>

<script>
// グローバル変数
let currentScheduleType = 'daily';
let editingScheduleId = null;

// フォームを開く
function openScheduleForm(scheduleData = null) {
    const container = document.getElementById('schedule-form-container');
    const title = document.getElementById('form-title');
    
    if (scheduleData) {
        // 編集モード
        editingScheduleId = scheduleData.id;
        title.textContent = '定期実行スケジュールを編集';
        
        document.getElementById('schedule-id').value = scheduleData.id;
        document.getElementById('schedule-name').value = scheduleData.name;
        document.getElementById('schedule-description').value = scheduleData.description || '';
        
        if (scheduleData.relative_preset) {
            document.getElementById('relative-preset').value = scheduleData.relative_preset;
        }
        
        setScheduleType(scheduleData.schedule_type);
        document.getElementById('execution-time').value = scheduleData.execution_time;
        
        if (scheduleData.day_of_week !== null) {
            document.getElementById('day-of-week').value = scheduleData.day_of_week;
        }
        if (scheduleData.day_of_month !== null) {
            document.getElementById('day-of-month').value = scheduleData.day_of_month;
        }
        
        document.getElementById('schedule-enabled').checked = scheduleData.is_enabled;
    } else {
        // 新規作成モード
        editingScheduleId = null;
        title.textContent = '新規定期実行スケジュール';
        document.getElementById('schedule-form').reset();
        setScheduleType('daily');
    }
    
    container.style.display = 'block';
}

// フォームを閉じる
function closeScheduleForm() {
    document.getElementById('schedule-form-container').style.display = 'none';
    editingScheduleId = null;
}

// スケジュールタイプを設定
function setScheduleType(type) {
    currentScheduleType = type;
    
    // ボタンのスタイルを更新
    const buttons = document.querySelectorAll('.schedule-type-btn');
    buttons.forEach(btn => {
        if (btn.id === `schedule-type-${type}`) {
            btn.className = 'schedule-type-btn px-3 py-2 border rounded-md text-sm font-medium transition-colors bg-blue-50 border-blue-500 text-blue-700';
        } else {
            btn.className = 'schedule-type-btn px-3 py-2 border rounded-md text-sm font-medium transition-colors bg-white border-gray-300 text-gray-700';
        }
    });
    
    // 曜日/日付選択の表示/非表示
    document.getElementById('day-of-week-container').style.display = type === 'weekly' ? 'block' : 'none';
    document.getElementById('day-of-month-container').style.display = type === 'monthly' ? 'block' : 'none';
}

// フォーム送信
async function submitScheduleForm(event) {
    event.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '処理中...';
    
    try {
        // データソースIDを取得
        const dataSourceSelect = document.querySelector('select[x-model="dataSourceId"]');
        const dataSourceId = dataSourceSelect ? dataSourceSelect.value : '1';
        
        const data = {
            name: document.getElementById('schedule-name').value,
            description: document.getElementById('schedule-description').value || null,
            sync_type: 'full',
            relative_preset: document.getElementById('relative-preset').value,
            data_source_id: parseInt(dataSourceId),
            schedule_type: currentScheduleType,
            execution_time: document.getElementById('execution-time').value,
            day_of_week: currentScheduleType === 'weekly' ? parseInt(document.getElementById('day-of-week').value) : null,
            day_of_month: currentScheduleType === 'monthly' ? parseInt(document.getElementById('day-of-month').value) : null,
            is_enabled: document.getElementById('schedule-enabled').checked
        };
        
        const url = editingScheduleId 
            ? `/api/v1/daily-quotes/schedules/${editingScheduleId}`
            : '/api/v1/daily-quotes/schedules';
        
        const method = editingScheduleId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            // スケジュール一覧を更新
            if (typeof htmx !== 'undefined') {
                htmx.trigger('#schedule-list-container', 'refresh-schedules');
            }
            closeScheduleForm();
        } else {
            const error = await response.json();
            alert('エラー: ' + (error.detail || 'スケジュールの保存に失敗しました'));
        }
    } catch (error) {
        alert('エラー: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '保存';
    }
}

// 編集用の関数（グローバルに公開）
window.editSchedule = function(scheduleData) {
    openScheduleForm(scheduleData);
};
</script>