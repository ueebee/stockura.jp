<!-- 日次株価データ定期実行スケジュール設定モーダル -->
<div id="daily-quotes-schedule-modal" 
     class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity z-50 hidden"
     x-data="dailyQuotesScheduleManager()"
     x-show="isOpen"
     @click.away="closeModal()"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl"
                 @click.outside="closeModal()">
                
                <!-- ヘッダー -->
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">定期実行スケジュール設定</h3>
                        <button @click="closeModal()" class="text-gray-400 hover:text-gray-500">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- フォーム -->
                    <form @submit.prevent="saveSchedule" class="space-y-4">
                        <!-- スケジュール名 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">スケジュール名</label>
                            <input type="text" x-model="scheduleName" required
                                   placeholder="例: 日次更新（過去7日間）"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <!-- 説明 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">説明（任意）</label>
                            <textarea x-model="description" rows="2"
                                      placeholder="例: 毎朝6時に過去7日間のデータを取得"
                                      class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        
                        <!-- データソース選択 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">データソース</label>
                            <select x-model="dataSourceId" required
                                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                {% for ds in data_sources %}
                                {% if ds.provider_type == 'jquants' and ds.is_enabled %}
                                <option value="{{ ds.id }}">{{ ds.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- 同期タイプ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">同期タイプ</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button"
                                        @click="syncType = 'incremental'"
                                        :class="{'bg-blue-50 border-blue-500 text-blue-700': syncType === 'incremental', 'bg-white border-gray-300 text-gray-700': syncType !== 'incremental'}"
                                        class="px-3 py-2 border rounded-md text-sm font-medium transition-colors">
                                    特定日（前日のみ）
                                </button>
                                <button type="button"
                                        @click="syncType = 'full'"
                                        :class="{'bg-blue-50 border-blue-500 text-blue-700': syncType === 'full', 'bg-white border-gray-300 text-gray-700': syncType !== 'full'}"
                                        class="px-3 py-2 border rounded-md text-sm font-medium transition-colors">
                                    期間指定
                                </button>
                            </div>
                        </div>
                        
                        <!-- 期間設定（期間指定モードの場合） -->
                        <div x-show="syncType === 'full'" x-transition>
                            <label class="block text-sm font-medium text-gray-700 mb-2">取得期間</label>
                            <select x-model="relativePreset" required
                                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="yesterday">前日のみ</option>
                                <option value="last7days">実行日から過去7日間</option>
                                <option value="last30days">実行日から過去30日間</option>
                                <option value="last90days">実行日から過去90日間</option>
                                <option value="thisMonth">実行月の1日から前日まで</option>
                                <option value="lastMonth">前月全体</option>
                            </select>
                        </div>
                        
                        <!-- スケジュールタイプ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">実行頻度</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button type="button"
                                        @click="scheduleType = 'daily'"
                                        :class="{'bg-blue-50 border-blue-500 text-blue-700': scheduleType === 'daily', 'bg-white border-gray-300 text-gray-700': scheduleType !== 'daily'}"
                                        class="px-3 py-2 border rounded-md text-sm font-medium transition-colors">
                                    毎日
                                </button>
                                <button type="button"
                                        @click="scheduleType = 'weekly'"
                                        :class="{'bg-blue-50 border-blue-500 text-blue-700': scheduleType === 'weekly', 'bg-white border-gray-300 text-gray-700': scheduleType !== 'weekly'}"
                                        class="px-3 py-2 border rounded-md text-sm font-medium transition-colors">
                                    毎週
                                </button>
                                <button type="button"
                                        @click="scheduleType = 'monthly'"
                                        :class="{'bg-blue-50 border-blue-500 text-blue-700': scheduleType === 'monthly', 'bg-white border-gray-300 text-gray-700': scheduleType !== 'monthly'}"
                                        class="px-3 py-2 border rounded-md text-sm font-medium transition-colors">
                                    毎月
                                </button>
                            </div>
                        </div>
                        
                        <!-- 実行時刻 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">実行時刻（JST）</label>
                            <input type="time" x-model="executionTime" required
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <!-- 曜日選択（週次の場合） -->
                        <div x-show="scheduleType === 'weekly'" x-transition>
                            <label class="block text-sm font-medium text-gray-700 mb-2">実行曜日</label>
                            <select x-model="dayOfWeek" required
                                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="0">月曜日</option>
                                <option value="1">火曜日</option>
                                <option value="2">水曜日</option>
                                <option value="3">木曜日</option>
                                <option value="4">金曜日</option>
                                <option value="5">土曜日</option>
                                <option value="6">日曜日</option>
                            </select>
                        </div>
                        
                        <!-- 日付選択（月次の場合） -->
                        <div x-show="scheduleType === 'monthly'" x-transition>
                            <label class="block text-sm font-medium text-gray-700 mb-2">実行日</label>
                            <input type="number" x-model="dayOfMonth" min="1" max="31" required
                                   placeholder="1-31"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <!-- 有効/無効 -->
                        <div class="flex items-center">
                            <input type="checkbox" x-model="isEnabled" id="schedule-enabled"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="schedule-enabled" class="ml-2 block text-sm text-gray-900">
                                スケジュールを有効にする
                            </label>
                        </div>
                    </form>
                </div>
                
                <!-- フッター -->
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <button type="submit" @click="saveSchedule"
                            :disabled="isProcessing"
                            class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 sm:ml-3 sm:w-auto disabled:opacity-50">
                        <span x-show="!isProcessing">保存</span>
                        <span x-show="isProcessing">処理中...</span>
                    </button>
                    <button type="button" @click="closeModal()"
                            class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// モーダルの初期化を確実にする
document.addEventListener('DOMContentLoaded', function() {
    // Alpine.jsが利用可能になるまで待つ
    function initModal() {
        const modal = document.getElementById('daily-quotes-schedule-modal');
        if (modal && typeof Alpine !== 'undefined' && !modal.__x) {
            Alpine.initTree(modal);
        }
    }
    
    // すぐに試す
    initModal();
    
    // 少し遅れて再度試す
    setTimeout(initModal, 500);
});

// HTMXでロードされた場合のための初期化
if (typeof htmx !== 'undefined') {
    htmx.on('htmx:afterSettle', function(evt) {
        const modal = document.getElementById('daily-quotes-schedule-modal');
        if (modal && typeof Alpine !== 'undefined' && !modal.__x) {
            setTimeout(() => {
                Alpine.initTree(modal);
            }, 100);
        }
    });
}
</script>