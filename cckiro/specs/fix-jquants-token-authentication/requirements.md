# J-Quants API トークン認証自動化の要件

## 背景

task_execution_logs でトークン認証エラーが発生しています。.env ファイルに J-Quants の EMAIL と PASSWORD が設定されているにも関わらず、実際のタスク実行時に認証が行われていません。

## 現状の問題

1. **認証機能は実装済みだが使われていない**
   - `JQuantsAuthRepository`：トークン取得・更新機能実装済み
   - `AuthUseCase`：認証フローの実装済み
   - しかし、`listed_info_task_asyncpg`では認証なしで API クライアントを初期化

2. **エラーメッセージ**
   - "The incoming token is invalid or expired."
   - API アクセス時に認証トークンが渡されていない

3. **環境変数は設定済み**
   - JQUANTS_EMAIL="yosuke.kishi@ganbird.com"
   - JQUANTS_PASSWORD="B56UpTEmF8Nkb9"

## 要件

### 機能要件

1. **自動認証機能**
   - タスク実行時に自動的に.env の認証情報を使用
   - refresh_token と id_token を自動取得
   - トークンの有効期限を管理し、必要に応じて自動更新

2. **エラーハンドリング**
   - 認証失敗時の適切なエラーメッセージ
   - リトライ機能（ネットワークエラー時）
   - トークン期限切れ時の自動再認証

3. **トークンの永続化**
   - 取得したトークンを Redis またはファイルに保存
   - 次回実行時は保存されたトークンを優先使用
   - トークンが無効な場合のみ再認証

### 非機能要件

1. **パフォーマンス**
   - 不要な認証リクエストを避ける
   - トークンのキャッシュによる高速化

2. **セキュリティ**
   - パスワードは環境変数でのみ管理
   - トークンは適切に保護して保存

3. **互換性**
   - 既存のコードへの影響を最小限に
   - 他のタスクでも同じ認証機能を利用可能

## 制約事項

1. 既存のインターフェースを変更しない
2. .env ファイルの設定形式は変更しない
3. J-Quants API の仕様に準拠する

## 成功基準

1. `fetch_listed_info_task_asyncpg`タスクがトークンエラーなく実行される
2. トークンの自動更新が正常に動作する
3. 認証情報がキャッシュされ、再利用される
4. エラー時に適切なログが出力される