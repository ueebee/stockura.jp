# Stockura アーキテクチャドキュメント

## 概要

Stockura は、 J-Quants API を活用した株式情報管理システムです。本プロジェクトは、クリーンアーキテクチャの原則に基づいて設計されており、各レイヤーが明確に分離されています。

## アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                        │
│                   (FastAPI, Schemas)                        │
├─────────────────────────────────────────────────────────────┤
│                    Application Layer                        │
│                  (Use Cases, DTOs)                         │
├─────────────────────────────────────────────────────────────┤
│                      Domain Layer                           │
│          (Entities, Value Objects, Repositories)           │
├─────────────────────────────────────────────────────────────┤
│                  Infrastructure Layer                       │
│      (External APIs, Database, Cache, Implementations)      │
└─────────────────────────────────────────────────────────────┘
```

## レイヤーの詳細

### 1. Domain Layer（ドメイン層）

**責務**: ビジネスロジックとビジネスルールの定義

- **Entities（エンティティ）**: ビジネスドメインの中核となるオブジェクト
- **Value Objects（値オブジェクト）**: 不変で交換可能な値を表現
- **Repository Interfaces（リポジトリインターフェース）**: データアクセスの抽象化
- **Exceptions（例外）**: ドメイン固有の例外定義

### 2. Application Layer（アプリケーション層）

**責務**: ユースケースの実装とビジネスフローの調整

- **Use Cases（ユースケース）**: アプリケーションの具体的な操作を実装
- **DTOs（データ転送オブジェクト）**: レイヤー間のデータ転送用オブジェクト

### 3. Infrastructure Layer（インフラストラクチャ層）

**責務**: 外部システムとの連携と技術的な実装の詳細

- **Repository Implementations（リポジトリ実装）**: データアクセスの具体的な実装
- **External API Clients（外部 API クライアント）**: J-Quants API などとの通信
- **Database Models（データベースモデル）**: ORM モデルの定義
- **Cache（キャッシュ）**: データのキャッシング機構

### 4. Presentation Layer（プレゼンテーション層）

**責務**: ユーザーインターフェースと API エンドポイントの提供

- **API Endpoints（API エンドポイント）**: RESTful API の定義
- **Schemas（スキーマ）**: リクエスト/レスポンスの検証
- **Middleware（ミドルウェア）**: 横断的関心事の処理

## 主要コンポーネント

### 認証システム

J-Quants API の認証フローを管理します：

1. メールアドレスとパスワードでリフレッシュトークンを取得
2. リフレッシュトークンから ID トークンを取得
3. ID トークンを使用して API リクエストを認証

### 銘柄情報管理

上場銘柄の情報を管理します：

- 全銘柄一覧の取得
- 銘柄コードによる検索
- 市場区分・業種によるフィルタリング
- 会社名による検索

## 技術スタック

- **Web フレームワーク**: FastAPI
- **非同期処理**: asyncio, aiohttp
- **データベース**: PostgreSQL (SQLAlchemy)
- **キャッシュ**: Redis
- **タスクキュー**: Celery
- **外部 API**: J-Quants API, yfinance
- **テスト**: pytest, pytest-asyncio
- **コード品質**: black, isort, flake8, mypy

## ディレクトリ構造

```
stockura/
├── app/
│   ├── domain/           # ドメイン層
│   ├── application/      # アプリケーション層
│   ├── infrastructure/   # インフラストラクチャ層
│   ├── presentation/     # プレゼンテーション層
│   └── core/            # 共通設定・ユーティリティ
├── tests/               # テストコード
├── docs/                # ドキュメント
└── requirements.txt     # 依存パッケージ
```

## 設計原則

1. **依存性逆転の原則（DIP）**: 上位レイヤーは下位レイヤーに依存しない
2. **単一責任の原則（SRP）**: 各クラスは単一の責任を持つ
3. **開放閉鎖の原則（OCP）**: 拡張に対して開き、修正に対して閉じている
4. **インターフェース分離の原則（ISP）**: 必要なインターフェースのみに依存
5. **リスコフの置換原則（LSP）**: 派生型は基底型と置換可能

## 拡張ポイント

- 新しい外部 API の追加: Infrastructure レイヤーに実装を追加
- 新しいユースケースの追加: Application レイヤーに追加
- 新しいエンティティの追加: Domain レイヤーに追加
- 新しい API エンドポイントの追加: Presentation レイヤーに追加