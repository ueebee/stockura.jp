### **（仮称）株価データ取得・表示システム 開発計画書（草案）**

**日付**: 2025年6月17日

#### 1\. プロジェクト概要

本プロジェクトは、複数の外部APIから株価データを取得し、Webブラウザ上でインタラクティブに表示・分析するためのWebアプリケーションを開発する。開発においては、バックエンドからフロントエンドまでPythonを中心とした技術スタックで一貫させ、フロントエンドのJavaScriptコード記述を最小限に抑えることで、高い生産性とメンテナンス性を目指す。

#### 2\. 目的と背景

  * `yfinance`や`J-Quants API`など、複数のデータソースに対応可能な柔軟なシステムを構築する。
  * 外部APIにはレートリミットが存在するため、安定したデータ取得を実現する仕組みを導入する。
  * モダンなWeb技術（HTML over the wire）を活用し、SPA（シングルページアプリケーション）のようなリッチなユーザー体験を、複雑なフロントエンド開発なしで実現する。

#### 3\. 主要な機能要件

  * ユーザーがWeb UIを通じて銘柄を指定し、株価データの取得をリクエストできる。
  * データ取得処理はバックグラウンドで非同期に実行され、ユーザーは処理完了を待たずに他の操作が可能。
  * データ取得が完了すると、ページ全体をリロードすることなく、画面の一部が動的に更新されて結果が表示される。
  * 外部APIへのリクエストは、設定されたレートリミット（例: 1分間に10回など）を超えないように、ジョブキューシステムによって制御される。

#### 4\. 技術スタック（アーキテクチャ）

| 領域 | 技術選定 | 採用理由 |
| :--- | :--- | :--- |
| **言語** | Python 3.11+ | 豊富なライブラリとエコシステム。データ分析からWeb開発まで一貫して対応可能。 |
| **Webフレームワーク** | **FastAPI** | `asyncio`ベースの非常に高いパフォーマンス。型ヒントによる強力な開発支援と自動APIドキュメント生成。 |
| **フロントエンド技術** | **Hotwire (Turbo + Stimulus)** | JavaScriptをほぼ書かずに、HTML中心でリッチなUIを実現する「HTML over the wire」アプローチのため。 |
| **テンプレートエンジン** | **Jinja2** | FastAPIとの連携が容易で、サーバーサイドで動的にHTMLを生成するため。 |
| **ジョブキューシステム** | **Celery** or **ARQ** | 外部APIへのリクエストを非同期処理し、レートリミットを制御するため。\<br\>・**Celery**: 機能豊富で直接的なレートリミット設定が可能。\<br\>・**ARQ**: `asyncio`ネイティブでFastAPIとの親和性が高い。 |
| **メッセージブローカー** | **Redis** | Celery/ARQのバックエンドとして。高速なインメモリデータストア。 |
| **初期データソース** | `yfinance`, `J-Quants API` | 初期ターゲットとする株価データ取得ライブラリ/API。 |

#### 5\. 想定される処理フロー（例：データ取得時）

1.  ユーザーがブラウザで銘柄を入力し、「データ取得」ボタンをクリックする。
2.  ブラウザはFastAPIサーバーにリクエストを送信する (by Hotwire/Turbo)。
3.  FastAPIはリクエストを受け取り、即座に「処理中」の旨を示すHTML断片を返す。同時に、株価取得ジョブを**Celery/ARQ**のキューに登録する。
4.  ブラウザは受け取ったHTML断片でUIを部分更新し、「ローディング中...」などの表示に切り替える。
5.  独立して稼働している**ジョブワーカー**がキューからジョブを取得し、レートリミットを遵守しながら外部APIに株価データを問い合わせる。
6.  データ取得後、ワーカーは結果をデータベースに保存し、WebSocket等を通じて**Turbo Streams**をクライアントにプッシュする（または、クライアントがポーリングして結果を取得）。
7.  ブラウザはTurbo Streamsを受け取り、指定されたHTML要素（例: `id="stock-chart"`）の中身を、取得したデータから生成されたグラフや表に差し替える。

#### 6\. 今後の検討事項

  * **データベースの選定**: 取得した時系列データを保存するためのデータベース（PostgreSQL, TimescaleDB, SQLite等）を決定する。
  * **認証・認可**: ユーザー登録やログイン機能が必要かどうかの検討。
  * **UI/UXの詳細設計**: 具体的な画面レイアウトやコンポーネントの設計。
  * **デプロイ環境**: アプリケーションをどこで動かすか（Docker, クラウドサービスなど）の計画。
  * **テスト戦略**: ユニットテスト、結合テストの方針。
