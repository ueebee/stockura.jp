# ä¸Šå ´ä¼æ¥­ä¸€è¦§åŒæœŸæ©Ÿèƒ½ å®Ÿè£…è¨­è¨ˆæ›¸

## æ¦‚è¦
ä¸Šå ´ä¼æ¥­ä¸€è¦§ã‚’æ¯æ—¥å®šæœŸçš„ã«åŒæœŸã™ã‚‹æ©Ÿèƒ½ã®å®Ÿè£…è¨­è¨ˆæ›¸ã§ã™ã€‚ã‚·ãƒ³ãƒ—ãƒ«ã§é‹ç”¨ã—ã‚„ã™ã„è¨­è¨ˆã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

## åŸºæœ¬è¦ä»¶
- **å®šæœŸå®Ÿè¡Œ**: 1æ—¥1å›ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: JST 11:30ï¼‰
- **æ‰‹å‹•å®Ÿè¡Œ**: UIä¸Šã‹ã‚‰ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œå¯èƒ½
- **åŒæœŸæ–¹å¼**: æ¯æ—¥ãƒ•ãƒ«åŒæœŸï¼ˆå·®åˆ†å–å¾—ãªã—ï¼‰
- **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**: æœ€å°é™ã®è¨­å®šã®ã¿
- **å®Ÿè¡Œæ™‚é–“å¤‰æ›´**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šç”»é¢ã‹ã‚‰å¤‰æ›´å¯èƒ½
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—è¡¨ç¤º**: åŒæœŸå®Ÿè¡Œä¸­ã®é€²æ—ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤º
- **å‹•çš„å®Ÿè¡Œå±¥æ­´æ›´æ–°**: ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ãªã—ã§å®Ÿè¡Œå±¥æ­´ã‚’æ›´æ–°

## UIè¨­è¨ˆ

### 1. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ç®¡ç†ç”»é¢ã§ã®è¡¨ç¤º
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ J-Quants - ä¸Šå ´ä¼æ¥­ä¸€è¦§                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ çŠ¶æ…‹: â— æœ‰åŠ¹                                             â”‚
â”‚                                                          â”‚
â”‚ å®šæœŸå®Ÿè¡Œ: æ¯æ—¥ 05:00 (JST)  [å¤‰æ›´]                      â”‚
â”‚                                                          â”‚
â”‚ æœ€çµ‚åŒæœŸ: 2025-07-10 05:02:34                           â”‚
â”‚ åŒæœŸä»¶æ•°: 3,854 ç¤¾                                      â”‚
â”‚ æ¬¡å›å®Ÿè¡Œ: 2025-07-11 05:00:00                           â”‚
â”‚                                                          â”‚
â”‚ [ä»Šã™ãåŒæœŸ] [å®Ÿè¡Œå±¥æ­´ã‚’è¦‹ã‚‹]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å®šæœŸå®Ÿè¡Œæ™‚é–“ã®å¤‰æ›´UI
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®šæœŸå®Ÿè¡Œæ™‚é–“ã®è¨­å®š                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ å®Ÿè¡Œæ™‚é–“: [05] : [00] (JST)                             â”‚
â”‚                                                          â”‚
â”‚ â€» æ¯æ—¥æŒ‡å®šæ™‚åˆ»ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™                         â”‚
â”‚ â€» å‡¦ç†æ™‚é–“ã‚’è€ƒæ…®ã—ã¦ã€å–å¼•æ™‚é–“å¤–ã‚’æ¨å¥¨                   â”‚
â”‚                                                          â”‚
â”‚ [ä¿å­˜] [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å®Ÿè¡ŒçŠ¶æ³ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‡¦ç†ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”„ ä¸Šå ´ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...                             â”‚
â”‚                                                          â”‚
â”‚ [ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã¾ãŸã¯ã‚¹ãƒ”ãƒŠãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³]            â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â†“ å®Œäº†å¾Œ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŒæœŸä»¶æ•°: 4,411ä»¶                                       â”‚
â”‚ å‡¦ç†æ™‚é–“: 4.5ç§’                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­è¨ˆ

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

#### ApiEndpointScheduleï¼ˆæ–°è¦è¿½åŠ ï¼‰
```python
class ApiEndpointSchedule(Base):
    """APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«"""
    __tablename__ = "api_endpoint_schedules"
    
    id: Mapped[int] = mapped_column(primary_key=True)
    endpoint_id: Mapped[int] = mapped_column(ForeignKey("api_endpoints.id"))
    
    # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
    is_enabled: Mapped[bool] = mapped_column(default=True)
    schedule_type: Mapped[str] = mapped_column(String(20), default="daily")  # daily only for now
    execution_time: Mapped[time] = mapped_column(Time, default=time(5, 0))  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 5:00
    timezone: Mapped[str] = mapped_column(String(50), default="Asia/Tokyo")
    
    # å®Ÿè¡Œå±¥æ­´
    last_execution_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True))
    last_execution_status: Mapped[Optional[str]] = mapped_column(String(20))  # success/failed
    last_sync_count: Mapped[Optional[int]] = mapped_column(Integer)
    
    # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    updated_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    endpoint: Mapped["ApiEndpoint"] = relationship(back_populates="schedule")
```

### 2. ã‚µãƒ¼ãƒ“ã‚¹å±¤

#### CompanySyncServiceï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
```python
class CompanySyncService:
    """ä¸Šå ´ä¼æ¥­åŒæœŸã‚µãƒ¼ãƒ“ã‚¹ï¼ˆã‚·ãƒ³ãƒ—ãƒ«å®Ÿè£…ï¼‰"""
    
    def __init__(self, db: AsyncSession, jquants_client: JQuantsClient):
        self.db = db
        self.jquants_client = jquants_client
    
    async def sync_all_companies(self) -> Dict[str, Any]:
        """å…¨ä¸Šå ´ä¼æ¥­ã‚’åŒæœŸï¼ˆãƒ•ãƒ«åŒæœŸï¼‰"""
        start_time = datetime.now()
        
        try:
            # 1. J-Quantsã‹ã‚‰å…¨éŠ˜æŸ„å–å¾—
            companies_data = await self.jquants_client.get_all_listed_companies()
            
            # 2. æ—¢å­˜ã®å…¨ä¼æ¥­ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            await self.db.execute(
                update(Company).values(is_active=False)
            )
            
            # 3. å–å¾—ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬æ›´æ–°ï¼ˆupsertï¼‰
            sync_count = 0
            for company_data in companies_data:
                await self._upsert_company(company_data)
                sync_count += 1
            
            await self.db.commit()
            
            # 4. å®Ÿè¡Œå±¥æ­´ã‚’æ›´æ–°
            duration = (datetime.now() - start_time).total_seconds()
            
            return {
                "status": "success",
                "sync_count": sync_count,
                "duration": duration,
                "executed_at": start_time
            }
            
        except Exception as e:
            await self.db.rollback()
            return {
                "status": "failed",
                "error": str(e),
                "executed_at": start_time
            }
    
    async def _upsert_company(self, company_data: Dict):
        """ä¼æ¥­æƒ…å ±ã‚’upsert"""
        stmt = insert(Company).values(
            code=company_data["Code"],
            company_name=company_data["CompanyName"],
            company_name_english=company_data.get("CompanyNameEnglish"),
            sector17_code=company_data.get("Sector17Code"),
            sector33_code=company_data.get("Sector33Code"),
            scale_category=company_data.get("ScaleCategory"),
            market_code=company_data.get("MarketCode"),
            is_active=True,
            reference_date=datetime.now().date()
        ).on_conflict_do_update(
            index_elements=["code"],
            set_={
                "company_name": company_data["CompanyName"],
                "company_name_english": company_data.get("CompanyNameEnglish"),
                "sector17_code": company_data.get("Sector17Code"),
                "sector33_code": company_data.get("Sector33Code"),
                "scale_category": company_data.get("ScaleCategory"),
                "market_code": company_data.get("MarketCode"),
                "is_active": True,
                "reference_date": datetime.now().date(),
                "updated_at": datetime.now()
            }
        )
        await self.db.execute(stmt)
```

### 3. Celeryã‚¿ã‚¹ã‚¯ï¼ˆå®Ÿè£…æ¸ˆã¿ - é‡è¦ãªå¤‰æ›´ç‚¹ã‚ã‚Šï¼‰

#### tasks/company_tasks.py
```python
from app.core.celery_app import celery_app
from app.services.company_sync_service import CompanySyncService
from app.models.api_endpoint import ApiEndpointSchedule

@celery_app.task(bind=True, name="sync_listed_companies")
def sync_listed_companies(self, execution_type: str = "manual"):
    """ä¸Šå ´ä¼æ¥­ä¸€è¦§ã®åŒæœŸã‚¿ã‚¹ã‚¯ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰"""
    
    async def _sync():
        # é‡è¦: å„ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã§æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
        # ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—é–“ã§ã®æ¥ç¶šå†åˆ©ç”¨å•é¡Œã‚’å›é¿
        from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
        from app.config import settings
        
        # æ–°ã—ã„éåŒæœŸã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆ
        task_async_engine = create_async_engine(
            settings.DATABASE_URL.replace("postgresql://", "postgresql+asyncpg://"),
            echo=False,
            future=True,
            pool_pre_ping=True,
        )
        
        # æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
        task_session_maker = async_sessionmaker(
            task_async_engine,
            class_=AsyncSession,
            expire_on_commit=False,
            autocommit=False,
            autoflush=False,
        )
        
        try:
            async with task_session_maker() as async_db:
                # ã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–
                data_source_service = DataSourceService(async_db)
                jquants_client_manager = JQuantsClientManager(data_source_service)
                sync_service = CompanySyncService(async_db, data_source_service, jquants_client_manager)
                
                # é€²æ—æ›´æ–°
                self.update_state(
                    state='PROGRESS',
                    meta={
                        'current': 0,
                        'total': 1,
                        'message': 'ä¸Šå ´ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...'
                    }
                )
                
                # åŒæœŸå®Ÿè¡Œ
                result = await sync_service.sync_all_companies_simple()
                return result
        finally:
            # ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            await task_async_engine.dispose()
    
    # æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã§å®Ÿè¡Œ
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    try:
        result = loop.run_until_complete(_sync())
    finally:
        loop.close()
    
    # å®Ÿè¡Œãƒ­ã‚°ã®ä½œæˆï¼ˆåŒæœŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œï¼‰
    # ... å®Ÿè¡Œãƒ­ã‚°ä½œæˆå‡¦ç† ...
    
    return result
```

#### é‡è¦ãªå®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹
1. **Celeryãƒ¯ãƒ¼ã‚«ãƒ¼ã®ãƒ—ãƒ¼ãƒ«è¨­å®š**: `solo`ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ï¼ˆdocker-compose.ymlï¼‰
   ```yaml
   worker:
     command: celery -A app.core.celery_app worker --loglevel=info --pool=solo
   ```

2. **éåŒæœŸå‡¦ç†ã®åˆ†é›¢**: å„ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã§ç‹¬è‡ªã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ä½œæˆ

### 4. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†

#### ScheduleService
```python
class ScheduleService:
    """ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def update_schedule_time(
        self, 
        endpoint_id: int, 
        execution_time: time
    ) -> ApiEndpointSchedule:
        """å®Ÿè¡Œæ™‚é–“ã‚’æ›´æ–°"""
        schedule = await self.db.query(ApiEndpointSchedule).filter(
            ApiEndpointSchedule.endpoint_id == endpoint_id
        ).first()
        
        if not schedule:
            raise ValueError("Schedule not found")
        
        schedule.execution_time = execution_time
        schedule.updated_at = datetime.now()
        
        # Celery Beatã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ›´æ–°
        self._update_celery_beat_schedule(endpoint_id, execution_time)
        
        await self.db.commit()
        return schedule
    
    def _update_celery_beat_schedule(self, endpoint_id: int, execution_time: time):
        """Celery Beatã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‹•çš„æ›´æ–°"""
        from celery.schedules import crontab
        
        # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¨ãƒ³ãƒˆãƒªã‚’æ›´æ–°
        schedule_name = f"sync_companies_{endpoint_id}"
        
        celery_app.conf.beat_schedule[schedule_name] = {
            'task': 'sync_listed_companies',
            'schedule': crontab(
                hour=execution_time.hour,
                minute=execution_time.minute
            ),
            'args': [],
            'options': {
                'timezone': 'Asia/Tokyo'
            }
        }
```

### 5. API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

#### æ‰‹å‹•å®Ÿè¡Œã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆHTMXã«å¯¾å¿œï¼‰
```python
@router.post("/sync-companies-action")
async def sync_companies_action(
    request: Request,
    db: Session = Depends(get_db),
):
    """ä¸Šå ´ä¼æ¥­ä¸€è¦§ã‚’æ‰‹å‹•ã§åŒæœŸï¼ˆHTMXç”¨ï¼‰"""
    # Celeryã‚¿ã‚¹ã‚¯ã‚’å³åº§ã«å®Ÿè¡Œ
    task = sync_listed_companies.delay(execution_type="manual")
    
    # HTMXãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦ã‚¿ã‚¹ã‚¯IDã‚’JSONã§è¿”ã™
    return HTMLResponse(
        content=f'<div id="sync-task-response" data-task-id="{task.id}"></div>'
    )
```

#### ã‚¿ã‚¹ã‚¯çŠ¶æ…‹ç¢ºèªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
```python
@router.get("/sync/task/{task_id}")
async def get_sync_task_status(task_id: str):
    """åŒæœŸã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹ã‚’å–å¾—ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—è¡¨ç¤ºç”¨ï¼‰"""
    from celery.result import AsyncResult
    
    result = AsyncResult(task_id)
    
    if result.state == 'PENDING':
        response = {
            'state': result.state,
            'current': 0,
            'total': 1,
            'status': 'å‡¦ç†å¾…æ©Ÿä¸­...'
        }
    elif result.state == 'PROGRESS':
        response = {
            'state': result.state,
            'current': result.info.get('current', 0),
            'total': result.info.get('total', 1),
            'status': result.info.get('message', 'å‡¦ç†ä¸­...')
        }
    elif result.state == 'SUCCESS':
        response = {
            'state': result.state,
            'current': 1,
            'total': 1,
            'status': 'åŒæœŸå®Œäº†',
            'result': result.info
        }
    else:  # FAILURE
        response = {
            'state': result.state,
            'current': 1,
            'total': 1,
            'status': f'ã‚¨ãƒ©ãƒ¼: {str(result.info)}',
            'error': str(result.info)
        }
    
    return response
```

#### å®Ÿè¡Œå±¥æ­´å–å¾—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
```python
@router.get("/data-sources/{data_source_id}/endpoints/{endpoint_id}/execution-history", 
           response_class=HTMLResponse)
async def get_endpoint_execution_history(
    request: Request,
    data_source_id: int,
    endpoint_id: int,
    db: Session = Depends(get_db),
):
    """ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè¡Œå±¥æ­´ã®ã¿ã‚’å–å¾—ï¼ˆHTMXç”¨ï¼‰"""
    # å®Ÿè¡Œå±¥æ­´ã‚’å–å¾—ã—ã¦HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
    # ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ãªã—ã§å®Ÿè¡Œå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
```

#### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ›´æ–°ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
```python
@router.put("/api/v1/companies/schedule")
async def update_company_sync_schedule(
    execution_time: time,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """åŒæœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ›´æ–°"""
    schedule_service = ScheduleService(db)
    
    updated_schedule = await schedule_service.update_schedule_time(
        endpoint_id=LISTED_COMPANIES_ENDPOINT_ID,
        execution_time=execution_time
    )
    
    return {
        "status": "success",
        "execution_time": updated_schedule.execution_time.strftime("%H:%M"),
        "timezone": updated_schedule.timezone
    }
```

## å®Ÿè£…ã®æµã‚Œ

### ãƒ•ã‚§ãƒ¼ã‚º1: åŸºæœ¬æ©Ÿèƒ½å®Ÿè£…ï¼ˆâœ… å®Œäº†ï¼‰
1. ApiEndpointScheduleãƒ¢ãƒ‡ãƒ«ã®è¿½åŠ 
2. CompanySyncServiceã®å®Ÿè£…ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
3. Celeryã‚¿ã‚¹ã‚¯ã®å®Ÿè£…

### ãƒ•ã‚§ãƒ¼ã‚º2: UIå®Ÿè£…ï¼ˆâœ… å®Œäº†ï¼‰
1. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ç”»é¢ã§ã®è¡¨ç¤º
2. æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³ã®å®Ÿè£…
3. å®Ÿè¡Œå±¥æ­´è¡¨ç¤º
4. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—è¡¨ç¤ºï¼ˆJavaScriptå®Ÿè£…ï¼‰
5. å‹•çš„å®Ÿè¡Œå±¥æ­´æ›´æ–°ï¼ˆHTMXå¯¾å¿œï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º3: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ï¼ˆâœ… å®Œäº†ï¼‰
1. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ›´UIã®å®Ÿè£…
2. ScheduleServiceã®å®Ÿè£…
3. Celery Beaté€£æº

### ãƒ•ã‚§ãƒ¼ã‚º4: ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼ˆâœ… å®Œäº†ï¼‰
1. å®Ÿè¡ŒçŠ¶æ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
3. é€šçŸ¥æ©Ÿèƒ½ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

## æŠ€è¡“çš„è€ƒæ…®äº‹é …

### 1. Celery Beatã®å‹•çš„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ›´æ–°
- Redisã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦ä½¿ç”¨
- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ›´æ™‚ã«Beatã‚’å†èµ·å‹•ä¸è¦

### 2. åŒæœŸå‡¦ç†ã®æœ€é©åŒ–
- ãƒãƒ«ã‚¯ã‚¤ãƒ³ã‚µãƒ¼ãƒˆ/ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
- ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã‚’è€ƒæ…®ã—ãŸãƒãƒƒãƒå‡¦ç†

### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- J-Quants APIéšœå®³æ™‚ã®ãƒªãƒˆãƒ©ã‚¤
- éƒ¨åˆ†çš„ãªå¤±æ•—ã®å‡¦ç†
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é©åˆ‡ãªé€šçŸ¥

### 4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- 4,000ä»¶ç¨‹åº¦ã®ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’5åˆ†ä»¥å†…ã§å‡¦ç†
- UIã®å¿œç­”æ€§ã‚’ä¿ã¤ãŸã‚ã®éåŒæœŸå‡¦ç†
- é€²æ—çŠ¶æ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

### 5. éåŒæœŸå‡¦ç†ã®æ³¨æ„ç‚¹ï¼ˆé‡è¦ï¼‰
- **ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®ç«¶åˆå•é¡Œ**: Celeryãƒ¯ãƒ¼ã‚«ãƒ¼ã§éåŒæœŸå‡¦ç†ã‚’ä½¿ç”¨ã™ã‚‹éš›ã®å•é¡Œ
  - å•é¡Œ: è¤‡æ•°ã®ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã§åŒã˜ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—/ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãŒå†åˆ©ç”¨ã•ã‚Œã‚‹
  - è§£æ±ºç­–: å„ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã§ç‹¬è‡ªã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ä½œæˆ
- **Celeryãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ¼ãƒ«**: `solo`ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰å®Ÿè¡Œã‚’ä¿è¨¼
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç®¡ç†**: ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œã«å¿…ãšæ¥ç¶šã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

## å®Ÿè£…ã§é­é‡ã—ãŸå•é¡Œã¨è§£æ±ºç­–

### 1. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—è¡¨ç¤ºã®å®Ÿè£…
- **å•é¡Œ**: HTMXãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚¿ã‚¹ã‚¯IDã‚’é©åˆ‡ã«å‡¦ç†ã§ããªã„
- **è§£æ±º**: 
  - å°‚ç”¨ã®éš ã—divè¦ç´ ï¼ˆ`#sync-task-response`ï¼‰ã§ã‚¿ã‚¹ã‚¯IDã‚’å—ã‘å–ã‚‹
  - JavaScriptã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã§ã‚¿ã‚¹ã‚¯IDã‚’æŠ½å‡ºã—ã¦å‡¦ç†

### 2. äº¤äº’ã«æˆåŠŸãƒ»å¤±æ•—ã‚’ç¹°ã‚Šè¿”ã™å•é¡Œ
- **å•é¡Œ**: ã€ŒTask attached to a different loopã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
- **åŸå› **: éåŒæœŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãŒã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—é–“ã§å†åˆ©ç”¨ã•ã‚Œã‚‹
- **è§£æ±º**: 
  1. Celeryãƒ¯ãƒ¼ã‚«ãƒ¼ã®ãƒ—ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ‰ã‚’`fork`ã‹ã‚‰`solo`ã«å¤‰æ›´
  2. å„ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã§ç‹¬è‡ªã®éåŒæœŸã‚¨ãƒ³ã‚¸ãƒ³ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
  3. ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œã«éåŒæœŸã‚¨ãƒ³ã‚¸ãƒ³ã‚’é©åˆ‡ã«dispose()

### 3. å®Ÿè¡Œå±¥æ­´ã®å‹•çš„æ›´æ–°
- **å•é¡Œ**: åŒæœŸå®Œäº†å¾Œã«ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ãŸ
- **è§£æ±º**: 
  - å®Ÿè¡Œå±¥æ­´éƒ¨åˆ†ã®ã¿ã‚’å–å¾—ã™ã‚‹å°‚ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆ
  - HTMXã‚’ä½¿ç”¨ã—ã¦éƒ¨åˆ†çš„ãªæ›´æ–°ã‚’å®Ÿç¾