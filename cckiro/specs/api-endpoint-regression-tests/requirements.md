# APIエンドポイント管理のリグレッションテスト 要件ファイル

## 1. 概要
本タスクは以下の2つの目的を持つ：
1. 本番データを用いたUIテスト（http://localhost:8000/data-sources/1/endpoints）の実行
2. 既存のbin/regression_test.pyのリファクタリング

## 2. テスト対象範囲

### 2.1 UIテスト対象
- APIエンドポイント管理画面 (`http://localhost:8000/data-sources/1/endpoints`)
  - 画面表示の正常性
  - エンドポイント一覧の表示
  - 各エンドポイントの詳細表示
  - 同期機能の動作確認
  - スケジュール設定機能の動作確認
  - 実行履歴の表示

### 2.2 リファクタリング対象
- bin/regression_test.py の既存コード
  - 約886行のコードの整理・分割
  - テストの再利用性向上
  - メンテナンス性の改善

## 3. テスト要件

### 3.1 UIテスト要件
1. **本番データを使用したテスト**
   - 本番環境と同等のデータベース状態でのテスト
   - 実際のAPIエンドポイント設定の確認
   - 本番で発生しうる状況の再現

2. **画面操作のテスト**
   - エンドポイント一覧の表示確認
   - 各エンドポイントの詳細画面への遷移
   - 手動同期機能の実行
   - スケジュール設定の作成・編集・削除
   - 実行履歴の確認

3. **エラーケースのテスト**
   - 不正な操作への対応確認
   - エラーメッセージの表示確認

### 3.2 リファクタリング要件
1. **コードの分割**
   - RegressionTesterクラスの責務分離
   - テストケースの独立したモジュール化
   - 共通処理の抽出

2. **設定管理の改善**
   - 環境変数の一元管理
   - テスト設定の外部化
   - デフォルト値の整理

3. **テスト実行の効率化**
   - 並列実行可能な構造への変更
   - テストの選択的実行機能
   - より詳細なレポート生成

4. **エラーハンドリングの改善**
   - 例外処理の統一
   - リトライ機能の拡張
   - ログ出力の改善

## 4. リファクタリング方針

### 4.1 ファイル構成
```
bin/
├── regression_test.py  # メインエントリポイント（軽量化）
└── regression_test/
    ├── __init__.py
    ├── config.py      # 設定管理
    ├── browser.py     # ブラウザ操作関連
    ├── database.py    # データベース操作関連
    ├── tests/
    │   ├── __init__.py
    │   ├── base.py    # テスト基底クラス
    │   ├── company_sync_test.py
    │   ├── daily_quotes_test.py
    │   └── schedule_crud_test.py
    ├── utils.py       # 共通ユーティリティ
    └── reporter.py    # レポート生成
```

### 4.2 改善ポイント
- 単一責任の原則に従った設計
- 依存性注入パターンの採用
- テストの独立性確保
- 設定のオーバーライド機能

## 5. 成功基準
- 既存のテスト機能が全て動作すること
- コードの可読性が向上すること
- 新規テストの追加が容易になること
- 本番データでのUIテストが正常に実行できること
- テスト実行時間が改善されること（または維持されること）

## 6. 制約事項
- 既存の使用方法（CLI引数）との後方互換性を維持
- Playwrightの使用は継続
- Docker環境での実行をサポート継続
- 既存のレポート形式を維持

## 7. 前提条件
- Python 3.8以上
- Playwright（オプション）
- Docker/Docker Compose
- 本番相当のデータベースダンプまたはセットアップスクリプト