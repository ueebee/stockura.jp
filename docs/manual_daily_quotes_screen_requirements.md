# 日時株価データ手動取得画面 要件定義書

## 1. 概要

J-Quants APIを使用して日時株価データを手動で取得するための画面を提供する。ユーザーは取得方法（特定銘柄の時系列データ、特定日の全銘柄データ、期間指定での取得）を選択し、必要なパラメータを入力してデータ取得を実行できる。

## 2. 画面構成

### 2.1 取得モード選択セクション

ユーザーが以下の3つの取得モードから選択できるようにする：

1. **特定銘柄モード** - 特定の銘柄コードの時系列データを取得
2. **特定日モード** - 特定の日付の全銘柄データを取得
3. **期間指定モード** - 特定銘柄の特定期間のデータを取得

### 2.2 パラメータ入力セクション

選択したモードに応じて、必要なパラメータの入力フィールドを表示する。

#### 2.2.1 特定銘柄モード
- **銘柄コード** (必須)
  - 入力形式: テキストボックス
  - バリデーション: 4桁の数字
  - 例: "7203" (トヨタ自動車)

#### 2.2.2 特定日モード
- **対象日** (必須)
  - 入力形式: 日付ピッカー
  - フォーマット: YYYY-MM-DD
  - デフォルト: 前営業日
  - 制限: 当日以前の日付のみ選択可能

#### 2.2.3 期間指定モード
- **銘柄コード** (必須)
  - 入力形式: テキストボックス
  - バリデーション: 4桁の数字
- **開始日** (必須)
  - 入力形式: 日付ピッカー
  - フォーマット: YYYY-MM-DD
  - デフォルト: 1年前の日付
- **終了日** (必須)
  - 入力形式: 日付ピッカー
  - フォーマット: YYYY-MM-DD
  - デフォルト: 前営業日
  - 制限: 開始日以降の日付のみ選択可能

### 2.3 オプション設定セクション

- **データソース選択**
  - ドロップダウンリスト
  - 登録済みのJ-Quantsデータソースから選択
  - デフォルト: プライマリデータソース

- **重複データの処理方法**
  - ラジオボタン
  - 選択肢:
    - 上書き更新 (デフォルト)
    - スキップ
    - エラーとして処理

### 2.4 実行制御セクション

- **実行ボタン**
  - クリックで取得処理を開始
  - 実行中は無効化

- **プログレスバー**
  - 取得進捗を表示
  - 処理件数/総件数を表示

- **ログ表示エリア**
  - 取得処理のログをリアルタイム表示
  - エラーメッセージの表示

## 3. 処理フロー

### 3.1 取得前チェック
1. 入力パラメータのバリデーション
2. データソースの認証状態確認
3. API利用制限の確認

### 3.2 取得処理
1. 選択されたモードに応じてAPIエンドポイントを構築
2. バッチ処理でデータを取得（ページネーション対応）
3. 取得データの妥当性チェック
4. データベースへの保存・更新

### 3.3 取得後処理
1. 処理結果のサマリー表示
   - 取得件数
   - 新規追加件数
   - 更新件数
   - スキップ件数
   - エラー件数
2. 同期履歴の記録

## 4. エラーハンドリング

### 4.1 入力エラー
- 必須項目の未入力
- フォーマットエラー（銘柄コード、日付）
- 論理エラー（終了日 < 開始日）

### 4.2 API関連エラー
- 認証エラー
- レート制限エラー
- タイムアウトエラー
- データ取得エラー

### 4.3 データ処理エラー
- データ妥当性エラー
- データベース保存エラー

## 5. UI/UXガイドライン

### 5.1 レスポンシブデザイン
- デスクトップ、タブレット、モバイルに対応
- 最小幅: 768px

### 5.2 アクセシビリティ
- キーボード操作対応
- スクリーンリーダー対応
- エラーメッセージの明確な表示

### 5.3 パフォーマンス
- 非同期処理による画面の応答性確保
- プログレス表示による進捗の可視化
- 大量データ取得時の適切なページング

## 6. セキュリティ要件

- 認証済みユーザーのみアクセス可能
- APIトークンの安全な管理
- 入力値のサニタイズ
- CSRFトークンの使用

## 7. 技術仕様

### 7.1 フロントエンド
- HTMX + Alpine.jsによる動的UI
- Tailwind CSSによるスタイリング
- WebSocketによるリアルタイム進捗更新

### 7.2 バックエンド
- FastAPIエンドポイント: `/api/v1/daily-quotes/manual-sync`
- Celeryタスクによる非同期処理
- DailyQuotesSyncServiceの利用

### 7.3 データベース
- DailyQuoteテーブルへの保存
- DailyQuotesSyncHistoryテーブルへの履歴記録

## 8. 今後の拡張性

- 複数銘柄の一括指定機能
- CSVファイルからの銘柄コード読み込み
- 定期実行スケジュールの設定
- 取得データのプレビュー機能
- エクスポート機能