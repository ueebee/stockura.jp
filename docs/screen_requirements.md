# 画面要求仕様書

## 1. 概要

### 1.1 目的
本ドキュメントは、株式データ管理システムの画面要求仕様を定義するものです。システムは複数のデータソース（J-Quants、Yahoo Finance等）から株価データを収集・管理し、分析機能を提供します。

### 1.2 スコープ
- 対象画面：Webアプリケーションの全画面
- 対象ユーザー：システム管理者、データアナリスト

### 1.3 システム概要
- **データソース（固定）**: 
  - J-Quants API（上場企業情報、日次株価、財務諸表）
  - Yahoo Finance（リアルタイム株価、ヒストリカルデータ）
- **バックグラウンド処理**: Celeryによる定期実行ジョブ
- **データ管理**: データソースごとに異なるデータ種類を個別管理

## 2. 画面一覧

### 2.1 ダッシュボード・モニタリング画面
- [ ] システムダッシュボード
- [ ] ジョブ実行状況モニター画面
- [ ] データ同期ステータス画面

### 2.2 データソース管理画面
- [x] データソース管理画面（設定・データ種類管理）
- [ ] APIエンドポイント管理画面
- [ ] 手動データ取得実行画面
- [ ] データ取得履歴画面

### 2.3 株価データ分析画面
- [ ] 銘柄一覧画面
- [ ] 銘柄詳細・チャート画面
- [ ] 株価データ分析画面
- [ ] 分析レポート画面

### 2.4 システム管理画面
- [ ] ジョブスケジュール管理画面
- [ ] エラーログ・監視画面
- [ ] システム設定画面

## 3. 画面詳細

### 3.1 システムダッシュボード（トップページ）

#### 3.1.1 画面概要
アプリケーションのトップページとして機能し、各種管理画面へのナビゲーションハブとなる画面。システムの概況を把握できるサマリー情報も表示。

#### 3.1.2 画面要素
**ナビゲーションエリア**
- 各種管理画面へのタイル型リンク
  - データソース管理
  - ジョブモニター
  - 株価分析
  - システム設定
- よく使う機能へのクイックアクセスボタン
- 検索バー（機能検索）

**サマリー情報エリア（ウィジェット形式）**
- システムステータスインジケーター
- アクティブなデータソース数
- 本日の同期実行回数
- 最新の同期結果サマリー
- エラー/警告通知エリア
- システムヘルスメーター（全体の健全性スコア）

**ユーザーエリア**
- ユーザー情報
- 最近のアクティビティ
- お気に入り機能
- 最近使用した機能の履歴（最大10件）

**拡張機能エリア**
- データ取得カレンダー（今週の予定ジョブ一覧）
- 重要指標のミニグラフ（株価指数、取得データ数等）
- クイック分析ウィジェット（人気銘柄、急騰/急落銘柄）

#### 3.1.3 機能要件
- 各画面への直感的なナビゲーション
- ウィジェットの表示/非表示切り替え
- ダッシュボードレイアウトのカスタマイズ（将来機能）
- 重要な通知のポップアップ表示
- ブレッドクラムナビゲーション

### 3.2 データソース管理画面

#### 3.2.1 画面概要
システムで利用可能なデータソースの設定と、各データソースが提供するデータ種類の管理を行う画面。

#### 3.2.2 画面要素
**データソース一覧（固定）**
- **J-Quants**
  - 提供データ種類：
    - 上場銘柄一覧（企業基本情報）
    - 日次株価データ（4本値、出来高）
    - 財務諸表データ（決算情報）
  - 認証方式：メールアドレス/パスワード
  - APIキー管理
- **Yahoo Finance**
  - 提供データ種類：
    - リアルタイム株価
    - ヒストリカルデータ
    - 企業プロファイル
  - 認証方式：不要（公開API）

**データソース設定パネル**
- データソース名（読み取り専用）
- 有効/無効トグル
- 認証情報設定
- レート制限設定
- データ種類別の取得設定
  - 各データ種類のON/OFF
  - 取得頻度設定
  - 取得対象範囲設定

**データ種類管理テーブル**
- データ種類名
- 最終取得日時
- 取得ステータス
- データ件数
- 手動実行ボタン

#### 3.2.3 機能要件
- データソースの有効化/無効化
- 認証情報の安全な保存・更新
- データ種類ごとの取得ON/OFF制御
- データ種類別の手動実行
- レート制限の可視化と調整
- 取得スケジュールの個別設定

### 3.3 APIエンドポイント管理画面

#### 3.3.1 画面概要
各データソースが提供するAPIエンドポイントの詳細管理、パラメータ設定、実行制御を行う画面。データソース管理画面から遷移して、特定のデータソースのエンドポイントを個別に管理。

#### 3.3.2 画面要素
**エンドポイント一覧テーブル**
- エンドポイント名（例：/idtoken、/listed/info、/prices/daily_quotes）
- エンドポイントの説明
- HTTPメソッド（GET/POST）
- データ種別（認証/上場企業情報/日次株価/財務諸表）
- ステータス（有効/無効）
- 実行モード（手動/自動/定期実行）
- 最終実行日時
- 次回実行予定
- データ取得件数
- アクション（設定/実行/履歴）

**エンドポイント設定パネル（エンドポイントごとの個別設定）**
- **基本設定**
  - エンドポイントURL（読み取り専用）
  - 有効/無効トグル
  - 実行モード選択（手動のみ/定期実行）
  - データ種別（読み取り専用）
  
- **パラメータ設定エリア**
  - 共通パラメータ
    - 認証トークン（自動設定）
    - レート制限設定
  - エンドポイント固有パラメータ
    - 企業一覧（/listed/info）
      - 取得モード：全件取得
      - フィルタ：市場区分
    - 日次株価（/prices/daily_quotes）
      - 対象銘柄：全銘柄/特定銘柄リスト/条件指定
      - 期間指定：開始日/終了日/過去N日
      - 分割実行：バッチサイズ
    - 財務諸表（/fins/statements）
      - 対象銘柄：全銘柄/特定銘柄リスト
      - 決算期：最新のみ/過去N期
  
- **スケジュール設定**（定期実行の場合）
  - 実行頻度（日次/週次/月次）
  - 実行時刻
  - 実行曜日（週次の場合）
  - 実行日（月次の場合）
  - タイムゾーン

- **詳細設定**
  - タイムアウト設定（秒）
  - リトライ回数
  - リトライ間隔（秒）
  - エラー時の動作（停止/継続/通知）
  - ログレベル

**実行制御パネル**
- 手動実行ボタン
- テスト実行（ドライラン）
- 実行状況表示
  - 進捗バー
  - 処理件数/総件数
  - 推定残り時間
  - 実行ログ（リアルタイム）

**データ取得履歴**
- 実行日時
- 実行種別（手動/定期）
- 取得件数
- 成功/失敗
- 実行時間
- エラー詳細（失敗時）

#### 3.3.3 機能要件
- **エンドポイント管理**
  - エンドポイントごとの有効化/無効化
  - パラメータのプリセット保存/読み込み
  - 設定のバリデーション
  
- **実行制御**
  - 手動実行（即時実行）
  - テスト実行（取得データのプレビュー）
  - バックグラウンド実行
  - 実行のキャンセル
  
- **スケジューリング**
  - Cron式での詳細設定（上級者向け）
  - 実行カレンダービュー
  - 依存関係の設定（他のエンドポイント完了後に実行）
  
- **モニタリング**
  - リアルタイム実行状況
  - 実行履歴の検索/フィルタ
  - パフォーマンスメトリクス
  - エラー分析

#### 3.3.4 エンドポイント別の特記事項
- **認証エンドポイント（/idtoken）**
  - 他のエンドポイント実行前に自動実行
  - トークンの有効期限管理
  
- **企業一覧（/listed/info）**
  - 基本的に全件取得
  - 差分更新の考慮
  
- **日次株価（/prices/daily_quotes）**
  - 大量データのため分割実行必須
  - 過去データの補完機能
  
- **財務諸表（/fins/statements）**
  - 決算発表時期に合わせた実行

### 3.4 ジョブ実行状況モニター画面

#### 3.4.1 画面概要
Celeryジョブの実行状況をリアルタイムで監視する画面。

#### 3.4.2 画面要素
- 実行中ジョブリスト
- ジョブキュー状況
- 実行履歴テーブル
- ジョブ種別フィルター
- パフォーマンスメトリクス

#### 3.4.3 機能要件
- ジョブのリアルタイム監視
- ジョブの手動実行/停止
- 実行ログの詳細表示
- エラージョブの再実行

### 3.5 手動データ取得実行画面

#### 3.5.1 画面概要
各データソースから手動でデータを取得するための実行・モニタリング画面。

#### 3.5.2 画面要素
**データソース選択エリア**
- データソース選択（J-Quants/Yahoo Finance）
- データ種類選択
  - J-Quants: 上場企業情報/日次株価/財務諸表
  - Yahoo Finance: リアルタイム/ヒストリカル
- 取得パラメータ設定
  - 対象銘柄（全銘柄/特定銘柄）
  - 期間指定（開始日/終了日）
  - オプション設定

**実行制御エリア**
- 実行前チェック
  - API接続状態
  - レート制限状態
  - 必要な認証情報
- 実行ボタン
- 一時停止/再開ボタン
- キャンセルボタン

**進捗表示エリア**
- プログレスバー
- 処理中メッセージ
- 取得済み/総件数
- 推定残り時間
- リアルタイムログ

#### 3.5.3 機能要件
- ドライラン（取得シミュレーション）
- バッチサイズ調整
- エラー時の部分再実行
- 取得結果のプレビュー
- 実行履歴の記録

### 3.6 株価データ分析画面

#### 3.6.1 画面概要
収集した株価データの分析・可視化を行う画面。

#### 3.6.2 画面要素
- 銘柄検索・選択エリア
- チャート表示エリア（複数銘柄対応）
- テクニカル指標選択
- 期間選択
- 分析結果表示エリア

#### 3.6.3 機能要件
- 複数銘柄の比較分析
- テクニカル指標の表示
- データエクスポート機能
- カスタム分析の保存

## 4. 共通コンポーネント

### 4.1 グローバルヘッダー
- **ロゴ・アプリケーション名**
- **グローバル検索バー**
  - 銘柄コード検索
  - 企業名検索
  - 機能検索
- **ユーザーメニュー**
  - プロフィール
  - 設定
  - ログアウト
- **通知アイコン**（未読数バッジ付き）
- **ヘルプ/チュートリアルボタン**
- **言語切り替え**（日/英）
- **ダークモード切り替えトグル**

### 4.2 グローバルフッター
- **システム情報**
  - バージョン情報
  - 最終更新日時
- **リンク集**
  - ドキュメント
  - APIリファレンス
  - サポート
- **著作権表示**

### 4.3 サイドバーナビゲーション
- **折りたたみ可能なメニュー**
- **アイコン付きメニュー項目**
- **現在地のハイライト表示**
- **サブメニューの展開/収納**

## 5. 共通要件

### 5.1 デザイン要件
- レスポンシブデザイン対応
- モバイルファースト
- ダークモード対応
- 管理画面に適したUIフレームワーク使用

### 5.2 アクセシビリティ要件
- WCAG 2.1 AA準拠
- キーボードナビゲーション対応
- スクリーンリーダー対応

### 5.3 パフォーマンス要件
- 初期表示: 3秒以内
- API応答: 1秒以内（大量データ除く）
- リアルタイム更新: 1秒間隔

### 5.4 セキュリティ要件
- 認証・認可機能
- APIキーの安全な管理
- 通信の暗号化（HTTPS）

### 5.5 ユーザビリティ要件
- **初回利用時のサポート**
  - ウェルカムウィザード
  - インタラクティブチュートリアル
  - サンプルデータでのデモ
- **操作補助機能**
  - コンテキストヘルプ（ツールチップ）
  - ステップバイステップガイド
  - エラー時の解決案提示
- **カスタマイズ機能**
  - ダッシュボードウィジェットの配置変更
  - テーマカラーの選択
  - ショートカットキーの設定
- **フィードバック機能**
  - 操作完了時の通知
  - プログレスバー表示
  - ローディング時のスケルトンスクリーン

## 6. 技術仕様

### 6.1 フロントエンド技術
- **フレームワーク**: React/Vue.js/Next.js（選定予定）
- **UIライブラリ**: Material-UI/Ant Design（選定予定）
- **状態管理**: Redux/Vuex/Zustand
- **チャートライブラリ**: Chart.js/Recharts/TradingView
- **リアルタイム通信**: WebSocket（Socket.io）

### 6.2 APIインターフェース
- **既存API**: FastAPI（バックエンド）
- **エンドポイント構成**:
  - `/api/v1/data-sources/`: データソース管理
  - `/api/v1/companies/`: 企業データ
  - `/api/v1/daily-quotes/`: 株価データ
  - `/api/v1/jobs/`: ジョブ管理（新規）
  - `/api/v1/analytics/`: 分析機能（新規）

### 6.3 必要な新規APIエンドポイント
- ジョブ実行状況取得
- ジョブの手動実行/停止
- リアルタイムステータス配信
- 分析結果の保存/取得
- システムメトリクス取得

## 7. 実装優先順位

### Phase 1（必須機能）
1. データソース一覧・管理画面（完了）
2. APIエンドポイント管理画面
3. データ取得ON/OFF制御機能
4. 手動データ取得実行機能
5. ジョブ実行状況モニター画面

### Phase 2（コア機能）
1. システムダッシュボード
2. 株価データ分析画面（基本機能）
3. エラーログ・監視画面

### Phase 3（拡張機能）
1. 高度な分析機能
2. レポート生成機能
3. 通知・アラート機能
4. ジョブスケジュール管理

## 8. 画面遷移とナビゲーション

### 8.1 基本的な画面フロー
```
トップページ（ダッシュボード）
├── データソース管理
│   ├── データソース一覧
│   ├── データソース詳細・編集
│   └── APIエンドポイント管理
│       ├── エンドポイント一覧
│       ├── エンドポイント設定
│       ├── パラメータ設定
│       ├── スケジュール設定
│       └── 実行履歴
├── 手動データ取得
│   └── 実行画面
├── ジョブモニター
│   ├── 実行中ジョブ
│   ├── ジョブ履歴
│   └── ジョブ詳細ログ
├── 株価分析
│   ├── 銘柄検索・一覧
│   ├── チャート表示
│   └── 分析レポート
└── システム管理
    ├── スケジュール設定
    ├── エラーログ
    └── システム設定
```

### 8.2 ナビゲーション要件
- グローバルナビゲーション（常時表示）
- パンくずリスト
- サイドバーメニュー（折りたたみ可能）
- キーボードショートカット対応

### 8.3 主要なキーボードショートカット
- `Ctrl/Cmd + K`: グローバル検索
- `Ctrl/Cmd + /`: ヘルプ表示
- `Alt + D`: ダッシュボードへ移動
- `Alt + S`: データソース管理へ移動
- `Alt + J`: ジョブモニターへ移動
- `Esc`: モーダル/ダイアログを閉じる

## 9. 今後の検討事項
- ユーザー権限管理の詳細設計
- 通知システムの実装方法（メール、Slack等）
- データのアーカイブ戦略
- バックアップ・リストア画面の必要性
- モバイルアプリの検討
- 多言語対応（日英）
- ダッシュボードのカスタマイズ機能の詳細
- PWA（Progressive Web App）対応
- オフライン機能の実装範囲