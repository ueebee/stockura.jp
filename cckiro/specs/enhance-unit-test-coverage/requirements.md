# ユニットテスト充実化 要件定義書

## 1. 概要
本タスクは、既存アプリケーションのユニットテストカバレッジを向上させ、コードの品質と信頼性を高めることを目的とします。

## 2. 現状分析

### 2.1 テストカバレッジ
- 現在のカバレッジ: 42.09%（目標: 80.00%）
- テスト失敗: 9 件（主にモックの設定不備）

### 2.2 主要な問題点
- インフラストラクチャ層のテストで実際の HTTP リクエストが発生している
- モックの設定が不適切で、期待する挙動と異なる
- 多くのクラス・メソッドにテストが存在しない

## 3. 要件

### 3.1 テストカバレッジ目標
- 全体のカバレッジを 80% 以上に向上させる
- 各レイヤーごとに以下の目標を設定：
  - ドメイン層: 95% 以上
  - アプリケーション層: 90% 以上
  - インフラストラクチャ層: 80% 以上
  - プレゼンテーション層: 70% 以上

### 3.2 テスト追加対象

#### 3.2.1 優先度高
1. **インフラストラクチャ層**
   - JQuantsAuthRepository の修正（現在失敗中のテスト）
   - RedisAuthRepository の修正（現在失敗中のテスト）
   - 未テストのリポジトリ実装クラス

2. **アプリケーション層**
   - 未テストのユースケースクラス
   - エラーハンドリングのテストケース

#### 3.2.2 優先度中
1. **プレゼンテーション層**
   - API ハンドラーのテスト
   - リクエスト/レスポンスの検証

2. **ドメイン層**
   - 未テストのエンティティ・値オブジェクト
   - ビジネスロジックの境界値テスト

### 3.3 テスト品質要件

1. **モック使用の適切化**
   - 外部 API への実際のリクエストを防ぐ
   - aiohttp のセッションを適切にモック化
   - 依存関係を明確に分離

2. **テストケースの網羅性**
   - 正常系・異常系の両方をカバー
   - 境界値テスト
   - エラーハンドリングの検証
   - 非同期処理の適切なテスト

3. **テストの保守性**
   - テストコードの重複を避ける
   - 共通のテストユーティリティを作成
   - フィクスチャの適切な使用

### 3.4 制約事項
- **実行コードの修正は禁止**（テストコードのみの修正・追加）
- 既存の正常に動作しているテストは変更しない
- テスト実行時間は全体で 5 分以内に収める

### 3.5 成果物
1. 修正・追加されたテストコード
2. テストカバレッジレポート（80% 以上達成）
3. すべてのテストが成功する状態

## 4. 検証基準
- `pytest tests/unit/` が警告なしで成功すること
- `pytest --cov=app --cov-report=term-missing tests/unit/` でカバレッジ 80% 以上
- 新規追加テストが独立して実行可能であること