<!-- 日次株価データ定期実行スケジュール一覧 -->
{% if schedules %}
<div class="overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">スケジュール名</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">同期タイプ</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">頻度</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">実行時刻</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">次回実行</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">状態</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">操作</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for schedule in schedules %}
            <tr>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                    <div>
                        <div class="font-medium">{{ schedule.name }}</div>
                        {% if schedule.description %}
                        <div class="text-xs text-gray-500">{{ schedule.description }}</div>
                        {% endif %}
                    </div>
                </td>
                <td class="px-4 py-2 whitespace-nowrap text-center">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                        {% if schedule.sync_type == 'full' %}bg-purple-100 text-purple-800
                        {% else %}bg-blue-100 text-blue-800{% endif %}">
                        {{ schedule.sync_type }}
                    </span>
                    {% if schedule.relative_preset %}
                    <div class="text-xs text-gray-600 mt-1">
                        {% if schedule.relative_preset == 'yesterday' %}前日のみ
                        {% elif schedule.relative_preset == 'last7days' %}過去7日間
                        {% elif schedule.relative_preset == 'last30days' %}過去30日間
                        {% elif schedule.relative_preset == 'last90days' %}過去90日間
                        {% elif schedule.relative_preset == 'thisMonth' %}今月
                        {% elif schedule.relative_preset == 'lastMonth' %}先月
                        {% endif %}
                    </div>
                    {% endif %}
                </td>
                <td class="px-4 py-2 whitespace-nowrap text-center text-sm text-gray-900">
                    {% if schedule.schedule_type == 'daily' %}
                        毎日
                    {% elif schedule.schedule_type == 'weekly' %}
                        毎週
                        {% if schedule.day_of_week == 0 %}月曜日
                        {% elif schedule.day_of_week == 1 %}火曜日
                        {% elif schedule.day_of_week == 2 %}水曜日
                        {% elif schedule.day_of_week == 3 %}木曜日
                        {% elif schedule.day_of_week == 4 %}金曜日
                        {% elif schedule.day_of_week == 5 %}土曜日
                        {% elif schedule.day_of_week == 6 %}日曜日
                        {% endif %}
                    {% elif schedule.schedule_type == 'monthly' %}
                        毎月{{ schedule.day_of_month }}日
                    {% endif %}
                </td>
                <td class="px-4 py-2 whitespace-nowrap text-center text-sm text-gray-900">
                    {{ schedule.execution_time }}
                </td>
                <td class="px-4 py-2 whitespace-nowrap text-center text-sm text-gray-900">
                    {% if schedule.is_enabled and schedule.next_run %}
                        <div>{{ schedule.next_run | to_jst }}</div>
                        {% if schedule.next_run_date_range %}
                        <div class="text-xs text-gray-500">
                            {{ schedule.next_run_date_range.from_date }} 〜 {{ schedule.next_run_date_range.to_date }}
                        </div>
                        {% endif %}
                    {% else %}
                        <span class="text-gray-400">-</span>
                    {% endif %}
                </td>
                <td class="px-4 py-2 whitespace-nowrap text-center">
                    <button onclick="toggleSchedule({{ schedule.id }})"
                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium cursor-pointer
                            {% if schedule.is_enabled %}bg-green-100 text-green-800 hover:bg-green-200
                            {% else %}bg-gray-100 text-gray-800 hover:bg-gray-200{% endif %}">
                        {% if schedule.is_enabled %}有効{% else %}無効{% endif %}
                    </button>
                </td>
                <td class="px-4 py-2 whitespace-nowrap text-center text-sm">
                    <button onclick="editSchedule({{ schedule | tojson | safe }})"
                            class="text-blue-600 hover:text-blue-900 mr-2">
                        編集
                    </button>
                    <button onclick="deleteSchedule({{ schedule.id }}, '{{ schedule.name }}')"
                            class="text-red-600 hover:text-red-900">
                        削除
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center py-8 text-gray-500">
    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <p class="mt-2">定期実行スケジュールが設定されていません</p>
</div>
{% endif %}

<script>
function toggleSchedule(scheduleId) {
    if (!confirm('スケジュールの有効/無効を切り替えますか？')) return;
    
    fetch(`/api/v1/daily-quotes/schedules/${scheduleId}/toggle`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            htmx.trigger('#schedule-list-container', 'refresh-schedules');
        }
    })
    .catch(error => {
        alert('エラー: ' + error.message);
    });
}

function editSchedule(scheduleData) {
    const modal = document.querySelector('[x-data="dailyQuotesScheduleManager()"]');
    if (modal && modal.__x) {
        modal.__x.$data.openModal(scheduleData);
    }
}

function deleteSchedule(scheduleId, scheduleName) {
    if (!confirm(`スケジュール「${scheduleName}」を削除しますか？`)) return;
    
    fetch(`/api/v1/daily-quotes/schedules/${scheduleId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            htmx.trigger('#schedule-list-container', 'refresh-schedules');
        }
    })
    .catch(error => {
        alert('エラー: ' + error.message);
    });
}
</script>